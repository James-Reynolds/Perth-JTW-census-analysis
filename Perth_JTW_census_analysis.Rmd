---
title: "Perth COVID-19 study; journey to work census analysis"
runningheader: "Perth COVID-19 study; journey to work census analysis" # only for pdf output
subtitle: "Perth COVID-19 study; journey to work census analysis" # only for html output
author: "Dr James Reynolds, Monash University Public Transport Research Group (PTRG)"
date: "`r Sys.Date()`"
output:
  tufte::tufte_html: default
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
bibliography: Perth_JTW_census_analysis.bib
link-citations: yes
---

```{r setup, include=FALSE}
library(tufte)
library(tidyverse)
library(sp)
library(ggplot2)
library(sf)
library(ASGS.foyer)
library(raster)
library(ggmap)
library(units)
library(absmapsdata)
library(readabs)
library(readr)
library(janitor)
library(scales)
library(ggstatsplot)
library(ggmap)
library(knitr)
library(abs)
library(readr)

# invalidate cache when the tufte version changes
knitr::opts_chunk$set(cache.extra = packageVersion('tufte'))
options(htmltools.dir.version = FALSE)
```

# 1.0 Introduction
The Monash University Public Transport Research Group is looking at changes in travel behaviour in Perth surrounding the COVID-19 pandemic. Part of this work involves examining the Australian Bureau of Statistics (ABS) journey-to-work data for the 2016 and 2021 censuses. Areas of interest are: 

- Aggregate Analysis for all of Greater Perth area

- Disaggregate Area Analysis for the three areas of Perth definied in previous PTRG work^[See Graham's sample size jottings worksheet.]: the North-south Group ^[City of Melville, City of South Perth, City of Stirling, City of Joondalup, City of Wanneroo, City of Cockburn, City of Kwinana, City of Rockingham, City of Murray and City of Mandurah.], the Heritage Group ^[City of Bayswater, City of Belmont, City of Canning, City of Fremantle, City of Nedlands, City of Perth, City of Subiaco, City of Vincent, Shire of Peppermint Grove, Town of Bassendean, Town of Cambridge, Town of Claremont, Town of Cottesloe, Town of East Fremantle, Town of Mosman Park, Town of Victoria Park and City of Gosnells.] and the Outer east^[City of Kalamunda, City of Swan, Shire of Mundaring, City of Armadale, and Shire of Serpentine-Jarrahdale.].

-	Perth CBD^[Using the WADoT Perth Greater CBD Transport Plan https://www.transport.wa.gov.au/mediaFiles/projects/PROJECT_I_Perth_Greater_CBD_Transport_Plan_map.pdf the Central Perth CBD generally consists of the 2021 Statistical Area 1 (SA1) zones of 50302129706, 50302129703, 50302129714, 50302129704, 50302129707, 50302129715, 50302129713, 50302129711, 50302129724, 50302129720, 50302129709, 50302129708, 50302129729, 50302129726 and 50302129722.] / Non-CBD-based Jobs 
  - Aggregate Analysis: comparing journeys to the CBD with journeys not to the CBD.
  - Disaggregate Spatial Analysis, again using the North-South, Heritage and Outer East groups. 


This working note details the process of collecting and reviewing the ABS data. It is structured as follows: the next section details the processing of the ABS data; Section 3 presents the results; followed by a brief discussion in Section 4; and conclusions in Section 5. 

# 2.0 Methods and data processing

The Journey-To-Work (JTW) data was extracted using the Table Builder on the ABS website. Data from 2016 and 2021 for Greater Perth was obtained. Join this with the Destination Zones allows mode shares to be mapped, as shown in the margin figure.

```{r load_abs_jtw_data, echo=FALSE, message = FALSE, warning=FALSE, fig.margin=TRUE, fig.cap="Greater Perth, car driver mode share by destination zone, 2016", cache=TRUE}

Greater_Perth_JTW_by_destination_2016 <- read_csv("01 data/Greater_Perth_JTW_by_destination_2016.csv", 
    skip = 8)
Greater_Perth_JTW_by_destination_2021 <- read_csv("01 data/Greater_Perth_JTW_by_destination_2021.csv", 
    skip = 8)

Greater_Perth_SA1_UR_by_MTW15P_2016 <- read_csv("01 data/Greater_Perth_SA1_UR_by_MTW15P_2016.csv", 
    skip = 8)

Greater_Perth_SA1_UR_by_MTW15P_2021 <- read_csv("01 data/Greater_Perth_SA1_UR_by_MTW15P_2021.csv", 
    skip = 8)

#remove first empty row and last 5 rows with copyright info
Greater_Perth_JTW_by_destination_2016 <- Greater_Perth_JTW_by_destination_2016[2:(nrow(Greater_Perth_JTW_by_destination_2016)-5),]
Greater_Perth_JTW_by_destination_2021<- Greater_Perth_JTW_by_destination_2021[2:(nrow(Greater_Perth_JTW_by_destination_2021)-5),]

Greater_Perth_SA1_UR_by_MTW15P_2016 <- Greater_Perth_SA1_UR_by_MTW15P_2016[2:(nrow(Greater_Perth_SA1_UR_by_MTW15P_2016)-5),]
Greater_Perth_SA1_UR_by_MTW15P_2021 <- Greater_Perth_SA1_UR_by_MTW15P_2021[2:(nrow(Greater_Perth_SA1_UR_by_MTW15P_2021)-5),]


#Convert Train column to numeric
Greater_Perth_JTW_by_destination_2016$Train <- as.numeric(Greater_Perth_JTW_by_destination_2016$Train)
Greater_Perth_JTW_by_destination_2021$Train <- as.numeric(Greater_Perth_JTW_by_destination_2021$Train)


#update first column name to be dz_code_2016
names(Greater_Perth_JTW_by_destination_2016) <- 
  c("dz_code_2016", 
    names(Greater_Perth_JTW_by_destination_2016[,2:ncol(Greater_Perth_JTW_by_destination_2016)]))
#Do same update first column name to be dz_code_2021
names(Greater_Perth_JTW_by_destination_2021) <- 
  c("dz_code_2021", 
    names(Greater_Perth_JTW_by_destination_2021[,2:ncol(Greater_Perth_JTW_by_destination_2021)]))
#Update first column name to be SA1_CODE_2016
names(Greater_Perth_SA1_UR_by_MTW15P_2016) <- 
  c("SA1_CODE_2016", 
    names(Greater_Perth_SA1_UR_by_MTW15P_2016[,2:ncol(Greater_Perth_SA1_UR_by_MTW15P_2016)]))
#Update first column name to be SA1_CODE_2021
names(Greater_Perth_SA1_UR_by_MTW15P_2021) <- 
  c("SA1_CODE_2021", 
    names(Greater_Perth_SA1_UR_by_MTW15P_2021[,2:ncol(Greater_Perth_SA1_UR_by_MTW15P_2021)]))

Greater_Perth_JTW_by_destination_2016 <- tibble(Greater_Perth_JTW_by_destination_2016[,1:17])
Greater_Perth_JTW_by_destination_2021 <- tibble(Greater_Perth_JTW_by_destination_2021[,1:17])
Greater_Perth_SA1_UR_by_MTW15P_2016 <- tibble(Greater_Perth_SA1_UR_by_MTW15P_2016[,1:17])
Greater_Perth_SA1_UR_by_MTW15P_2021 <- tibble(Greater_Perth_SA1_UR_by_MTW15P_2021[,1:17])



####Next add the JTW data by DZ and LGA
## by Year and DZ and LGA data from ABS comes in a single file, with multiple CSV sections for each LGA. I found https://pypi.org/project/table_builder_io/ which deals with this issue over in python. 
##adapted from https://github.com/vlc/table_builder_io/ code in python
#from table_builder_io import TableBuilderReader
# Load python and pandas
#reader = TableBuilderReader.from_file("/Users/julianreynolds/Documents/work/Monash University/Greater_Perth_JTW_by_DZ_and_LGA_2021.csv")
#df = reader.read_table(as_index=True)
#df2 = reader.read(as_index=False)

##then from https://stackoverflow.com/a/55168518
#for i in df2: 
#   df2[i].to_csv('dataframe_id_'+str(i)+'.csv')
##All of this results in an output of everything in a separated CSV for each LGA. 
##Some stuffing around required as python does not play well with '0's and / etc in file names

#Load JTW by DZ and LGA data
list_csv_files <- list.files(path = "01 data/2016_JTW_by_DZ_and_LGA", full.names = TRUE)
Greater_Perth_JTW_by_DZ_and_LGA_2016 <- readr::read_csv(list_csv_files, id = "file_name")
list_csv_files <- list.files(path = "01 data/2021_JTW_by_DZ_and_LGA", full.names = TRUE)
Greater_Perth_JTW_by_DZ_and_LGA_2021 <- readr::read_csv(list_csv_files, id = "file_name")

#Extract LGA name from filename field
Greater_Perth_JTW_by_DZ_and_LGA_2016$lga_name_2021 <- sub(".*dataframe_id_","", Greater_Perth_JTW_by_DZ_and_LGA_2016$file_name)
Greater_Perth_JTW_by_DZ_and_LGA_2016$lga_name_2021 <- sub(".csv.*","", Greater_Perth_JTW_by_DZ_and_LGA_2016$lga_name_2021)


Greater_Perth_JTW_by_DZ_and_LGA_2021$lga_name_2021 <- sub(".*dataframe_id_","", Greater_Perth_JTW_by_DZ_and_LGA_2021$file_name)
Greater_Perth_JTW_by_DZ_and_LGA_2021$lga_name_2021 <- sub(".csv.*","", Greater_Perth_JTW_by_DZ_and_LGA_2021$lga_name_2021)

#Drop unneeded columns and put LGA column in first position
Greater_Perth_JTW_by_DZ_and_LGA_2016 <- tibble(
  lga_name_2021 = Greater_Perth_JTW_by_DZ_and_LGA_2016$lga_name_2021, 
  dz_code_2021 = Greater_Perth_JTW_by_DZ_and_LGA_2016$`DZN (POW)`,
  Greater_Perth_JTW_by_DZ_and_LGA_2016[,4:(ncol(Greater_Perth_JTW_by_DZ_and_LGA_2016)-2)]
)
Greater_Perth_JTW_by_DZ_and_LGA_2021 <- tibble(
  lga_name_2021 = Greater_Perth_JTW_by_DZ_and_LGA_2021$lga_name_2021, 
  dz_code_2021 = Greater_Perth_JTW_by_DZ_and_LGA_2021$`DZN (POW)`,
  Greater_Perth_JTW_by_DZ_and_LGA_2021[,4:(ncol(Greater_Perth_JTW_by_DZ_and_LGA_2021)-2)]
)

#remove total rows
Greater_Perth_JTW_by_DZ_and_LGA_2016 <- Greater_Perth_JTW_by_DZ_and_LGA_2016 %>% filter(dz_code_2021 != "Total")
Greater_Perth_JTW_by_DZ_and_LGA_2021 <- Greater_Perth_JTW_by_DZ_and_LGA_2021 %>% filter(dz_code_2021 != "Total")


```

The ABS provides correspondence files to convert between 2016 and 2021 destination zones, and between 2016 and 2021 SA1 zones. 

```{r load_abs_2021_2016_destination_zones_correspondence, echo=FALSE, fig.margin=TRUE, fig.cap="Perth 2021 destination zonea", cache=TRUE}

#Load DZ2021 to DZ2016 correspondence file
CG_DZN_2016_DZN_2021 <- read_csv("01 data/CG_DZN_2016_DZN_2021.csv")
CG_SA1_2016_SA1_2021 <- read_csv("01 data/CG_SA1_2016_SA1_2021.csv")

##convert 2016 DZ zones into 2021 DZ zones using the correspondence file from the ABS
#set so types are the same
CG_DZN_2016_DZN_2021$DZN_CODE_2016 <- as.character(CG_DZN_2016_DZN_2021$DZN_CODE_2016)
#Update first column name to be dz_code_2016 to match 
names(CG_DZN_2016_DZN_2021) <- 
  c("dz_code_2016", 
    names(CG_DZN_2016_DZN_2021[,2:ncol(CG_DZN_2016_DZN_2021)]))

#join
Greater_Perth_JTW_by_destination_2016 <- left_join(Greater_Perth_JTW_by_destination_2016, CG_DZN_2016_DZN_2021, by = "dz_code_2016")
#Seems like the by DZ and LGA data is already by 2021 DZ zones...not sure why that is
#Greater_Perth_JTW_by_DZ_and_LGA_2016 <- left_join(Greater_Perth_JTW_by_DZ_and_LGA_2016, CG_DZN_2016_DZN_2021, by = "dz_code_2016")

#multiply mode numbers by RATIO_FROM_TO value
Greater_Perth_JTW_by_destination_2016[,23:38] <- Greater_Perth_JTW_by_destination_2016[,2:17] * Greater_Perth_JTW_by_destination_2016$RATIO_FROM_TO

#Greater_Perth_JTW_by_DZ_and_LGA_2016[,24:39] <- Greater_Perth_JTW_by_DZ_and_LGA_2016[,3:18] * Greater_Perth_JTW_by_DZ_and_LGA_2016$RATIO_FROM_TO


#Drop unneeded columns
Greater_Perth_JTW_by_destination_2016 <- tibble(dz_code_2016 = Greater_Perth_JTW_by_destination_2016$dz_code_2016, dz_code_2021 = Greater_Perth_JTW_by_destination_2016$DZN_CODE_2021, Greater_Perth_JTW_by_destination_2016[,22:37])

#Greater_Perth_JTW_by_DZ_and_LGA_2016 <- tibble(lga_name_2021 = Greater_Perth_JTW_by_DZ_and_LGA_2016$lga_name_2021, dz_code_2016 = Greater_Perth_JTW_by_DZ_and_LGA_2016$dz_code_2016, dz_code_2021 = Greater_Perth_JTW_by_DZ_and_LGA_2016$DZN_CODE_2021, Greater_Perth_JTW_by_DZ_and_LGA_2016[,24:39])

##convert 2016 SA1 zones into 2021 SA1 zones using the corrspondence file from the ABS
#For some reason the correspondence file provides SA1_MAINCODE_2016, rather than SA1_CODE_2016. The main code is a different number, but there is a correspondance in the SA1_2016_AUST file from https://www.abs.gov.au/AUSSTATS/abs@.nsf/DetailsPage/1270.0.55.001July%202016?OpenDocument
#So import that
SA1_2016_AUST <- read_csv("01 data/SA1_2016_AUST.csv")

#set so types are the same
CG_SA1_2016_SA1_2021$SA1_MAINCODE_2016 <- as.character(CG_SA1_2016_SA1_2021$SA1_MAINCODE_2016)
SA1_2016_AUST$SA1_MAINCODE_2016 <- as.character(SA1_2016_AUST$SA1_MAINCODE_2016)
#join
CG_SA1_2016_SA1_2021 <- left_join(CG_SA1_2016_SA1_2021, SA1_2016_AUST, by = "SA1_MAINCODE_2016")

#set names the same
names(Greater_Perth_SA1_UR_by_MTW15P_2016) <- 
  c("SA1_7DIGITCODE_2016", 
    names(Greater_Perth_SA1_UR_by_MTW15P_2016[,2:ncol(Greater_Perth_SA1_UR_by_MTW15P_2016)]))


#again set so types are the same
Greater_Perth_SA1_UR_by_MTW15P_2016$SA1_7DIGITCODE_2016 <- as.character(Greater_Perth_SA1_UR_by_MTW15P_2016$SA1_7DIGITCODE_2016)
CG_SA1_2016_SA1_2021$SA1_7DIGITCODE_2016 <- as.character(CG_SA1_2016_SA1_2021$SA1_7DIGITCODE_2016)


#Now join to the Journey to work data
Greater_Perth_SA1_UR_by_MTW15P_2016 <- left_join(Greater_Perth_SA1_UR_by_MTW15P_2016, CG_SA1_2016_SA1_2021, by = "SA1_7DIGITCODE_2016")

#multiply mode numbers by RATIO_FROM_TO value
Greater_Perth_SA1_UR_by_MTW15P_2016[,36:51] <- Greater_Perth_SA1_UR_by_MTW15P_2016[,2:17] * as.numeric(Greater_Perth_SA1_UR_by_MTW15P_2016$RATIO_FROM_TO)
#Drop unneeded columns
Greater_Perth_SA1_UR_by_MTW15P_2016 <- tibble(SA1_CODE_2021 = Greater_Perth_SA1_UR_by_MTW15P_2016$SA1_CODE_2021, Greater_Perth_SA1_UR_by_MTW15P_2016[,36:51])

```

Next, add the Heritage, North-south and Outer east groupings to the datasets. To do this, however, it is necessary to add the Local Government Areas (LGA) details to each dataset.  LGAs do not directly correspond to SA1 boundaries, so it will be necessary to 1. load the SA1 and DZ geometry to the journey to work datasets, 2. Load the LGA geometry, 3. Find the intersections of the LGA boundaries and the SA1s and the intersections of the LGA boundaries and the DZs.  

First, loading the ABS mapping data via the absmapsdata package [@absmapsdata] gives:

```{r load_absmapsdata_destination_zones_2021, echo=FALSE, fig.margin=TRUE, fig.cap="Perth 2021 destination zonea", cache=TRUE}

#Load DZ2021 data
DZ2021_map_data <- dz2021

#Load SA1_2021 data
sa1_2021_map_data <- sa12021

#Get the Greater Capital City names by sa2 
sa2_gcc_code <- tibble(sa2_code_2021 = sa1_2021_map_data$sa2_code_2021,
                       sa2_name_2021 = sa1_2021_map_data$sa2_name_2021,
                       gcc_name_2021 = sa1_2021_map_data$gcc_name_2021)
#and only keep unique records
sa2_gcc_code <- distinct(sa2_gcc_code)


#join gcc_name_2021 into DZ2021 dataset
DZ2021_map_data <- left_join(DZ2021_map_data, sa2_gcc_code, by = "sa2_code_2021")

#convert square km values back to numeric class
DZ2021_map_data$areasqkm_2021 <- as.numeric(DZ2021_map_data$areasqkm_2021) 

#Map destination zones
map <- DZ2021_map_data %>%
  filter(gcc_name_2021 == "Greater Perth") %>%   # let's just look at Perth
  ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = areasqkm_2021),     # fill by area size
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf()

map

#join destination zone geometry to destination zone JTW data
Greater_Perth_JTW_by_destination_2016 <- left_join(Greater_Perth_JTW_by_destination_2016, DZ2021_map_data, by = "dz_code_2021")
Greater_Perth_JTW_by_destination_2021 <- left_join(Greater_Perth_JTW_by_destination_2021, DZ2021_map_data, by = "dz_code_2021")
```

```{r load_absmapsdata_SA1_zones_2021, echo=FALSE, fig.margin=TRUE, fig.cap="Perth 2021 destination zonea", cache=TRUE}

#Map SA1 zones
map <- sa1_2021_map_data %>%
  filter(gcc_name_2021 == "Greater Perth") %>%   # let's just look at Perth
  ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = areasqkm_2021),     # fill by area size
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf()

map


#set names the same
names(Greater_Perth_SA1_UR_by_MTW15P_2016) <- 
  c("sa1_code_2021", 
    names(Greater_Perth_SA1_UR_by_MTW15P_2016[,2:ncol(Greater_Perth_SA1_UR_by_MTW15P_2016)]))
names(Greater_Perth_SA1_UR_by_MTW15P_2021) <- 
  c("sa1_code_2021", 
    names(Greater_Perth_SA1_UR_by_MTW15P_2021[,2:ncol(Greater_Perth_SA1_UR_by_MTW15P_2021)]))

#join destination zone geometry to destination zone JTW data
Greater_Perth_SA1_UR_by_MTW15P_2016 <- left_join(Greater_Perth_SA1_UR_by_MTW15P_2016, sa1_2021_map_data, by = "sa1_code_2021")
Greater_Perth_SA1_UR_by_MTW15P_2021 <- left_join(Greater_Perth_SA1_UR_by_MTW15P_2021, sa1_2021_map_data, by = "sa1_code_2021")
```

Next get the LGA boundaries, find intersections with JTW dataset geometries, and assign the goupings into the dataset..


```{r add_groupings, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.cap="Greater Perth: Heritage, North-south and Outer East groupings", cache=TRUE}

#get ABS LGA boundaries
lga_areas <- lga2021 %>% filter(state_name_2021 == "Western Australia")


#turn JTW datasets into sf objected
Greater_Perth_JTW_by_destination_2016 <- st_sf(Greater_Perth_JTW_by_destination_2016)
Greater_Perth_JTW_by_destination_2021 <- st_sf(Greater_Perth_JTW_by_destination_2021)
Greater_Perth_SA1_UR_by_MTW15P_2016 <- st_sf(Greater_Perth_SA1_UR_by_MTW15P_2016)
Greater_Perth_SA1_UR_by_MTW15P_2021 <- st_sf(Greater_Perth_SA1_UR_by_MTW15P_2021)




#find intersections of SA1 and LGA and DZ and LGA boundaries
Greater_Perth_SA1_UR_by_MTW15P_2016 <- st_intersection(Greater_Perth_SA1_UR_by_MTW15P_2016, lga_areas)
Greater_Perth_SA1_UR_by_MTW15P_2021 <- st_intersection(Greater_Perth_SA1_UR_by_MTW15P_2016, lga_areas)
Greater_Perth_JTW_by_destination_2016 <- st_intersection(Greater_Perth_JTW_by_destination_2016, lga_areas)
Greater_Perth_JTW_by_destination_2021 <- st_intersection(Greater_Perth_JTW_by_destination_2021, lga_areas)



LGA_to_group <- tibble(lga_name_2021 = 
c("Melville", "South Perth", "Stirling", "Joondalup", "Wanneroo", "Cockburn", "Kwinana", "Rockingham", "Murray", "Mandurah",
  "Bayswater", "Belmont", "Canning","Fremantle", "Nedlands", "Perth", "Subiaco", "Vincent", "Peppermint Grove", "Bassendean", "Cambridge", "Claremont", "Cottesloe", "East Fremantle", "Mosman Park", "Victoria Park","Gosnells",
  "Kalamunda", "Swan", "Mundaring", "Armadale", "Serpentine-Jarrahdale", "Northam", "York"),
grouping = c("North-south", "North-south","North-south","North-south","North-south","North-south","North-south","North-south","North-south","North-south", "Heritage", "Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage", "Outer east", "Outer east","Outer east","Outer east","Outer east", "Outer east","Outer east")
)

#join grouping to JTW data frames
Greater_Perth_JTW_by_destination_2016 <- left_join(Greater_Perth_JTW_by_destination_2016, LGA_to_group, by = "lga_name_2021")
Greater_Perth_JTW_by_destination_2021 <- left_join(Greater_Perth_JTW_by_destination_2021, LGA_to_group, by = "lga_name_2021")
Greater_Perth_SA1_UR_by_MTW15P_2016 <- left_join(Greater_Perth_SA1_UR_by_MTW15P_2016, LGA_to_group, by = "lga_name_2021")
Greater_Perth_SA1_UR_by_MTW15P_2021 <- left_join(Greater_Perth_SA1_UR_by_MTW15P_2021, LGA_to_group, by = "lga_name_2021")


#fix names
names(Greater_Perth_JTW_by_destination_2016) <- c("dz_code_2021", "Train", "Bus", "Ferry", "Tram", "Taxi", "Car, as driver", "Car, as passenger", "Truck", "Motorbike", "Bicycle", "Walked only", "Other mode", "Worked at home", "Did not go to work", "Not stated", "Not applicable", "sa2_code_2021", "sa2_name_2021", "state_code_2021", "state_name_2021", "areasqkm_2021", "cent_lat", "cent_long", "sa2_name_2021.y", "sa2_name_2021.y", "gcc_name_2021", "lga_code_2021", "lga_name_2021", "state_code_2021.1", "state_name_2021.1", "areasqkm_2021.1", "cent_lat.1", "cent_long.1", "geometry", "grouping")

names(Greater_Perth_JTW_by_destination_2021) <- c("dz_code_2021", "Train", "Bus", "Ferry", "Tram", "Taxi", "Car, as driver", "Car, as passenger", "Truck", "Motorbike", "Bicycle", "Walked only", "Other mode", "Worked at home", "Did not go to work", "Not stated", "Not applicable", "sa2_code_2021", "sa2_name_2021", "state_code_2021", "state_name_2021", "areasqkm_2021", "cent_lat", "cent_long", "sa2_name_2021.y", "sa2_name_2021.y", "gcc_name_2021", "lga_code_2021", "lga_name_2021", "state_code_2021.1", "state_name_2021.1", "areasqkm_2021.1", "cent_lat.1", "cent_long.1", "geometry", "grouping")

names(Greater_Perth_SA1_UR_by_MTW15P_2016) <- c("sa1_code_2021", "Train", "Bus", "Ferry", "Tram", "Taxi", "Car, as driver", "Car, as passenger", "Truck", "Motorbike", "Bicycle", "Walked only", "Other mode", "Worked at home", "Did not go to work", "Not stated", "Not applicable", "sa2_code_2021", "sa2_name_2021", "sa3_code_2021", "sa3_name_2021", "sa4_code_2021", "sa4_name_2021", "gcc_code_2021", "gcc_name_2021", "state_code_2021", "state_name_2021", "areasqkm_2021", "cent_lat", "cent_long", "lga_code_2021", "lga_name_2021", "state_code_2021.1", "state_name_2021.1", "areasqkm_2021.1", "cent_lat.1", "cent_long.1", "geometry", "grouping")
names(Greater_Perth_SA1_UR_by_MTW15P_2021) <- c("sa1_code_2021", "Train", "Bus", "Ferry", "Tram", "Taxi", "Car, as driver", "Car, as passenger", "Truck", "Motorbike", "Bicycle", "Walked only", "Other mode", "Worked at home", "Did not go to work", "Not stated", "Not applicable", "sa2_code_2021", "sa2_name_2021", "sa3_code_2021", "sa3_name_2021", "sa4_code_2021", "sa4_name_2021", "gcc_code_2021", "gcc_name_2021", "state_code_2021", "state_name_2021", "areasqkm_2021", "cent_lat", "cent_long", "lga_code_2021", "lga_name_2021", "state_code_2021.1", "state_name_2021.1", "areasqkm_2021.1", "cent_lat.1", "cent_long.1", "lga_code_2021.1", "lga_name_2021.1", "state_code_2021.2", "state_name_2021.2", "areasqkm_2021.2", "cent_lat.2", "cent_long.2", "geometry", "grouping")


#Map Groupings
map <- Greater_Perth_SA1_UR_by_MTW15P_2016 %>%
    ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = grouping),     # fill by grouping
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf() 

map 


                      
```

For the JTW by destination and LGA files^[Greater_Perth_JTW_by_DZ_and_LGA_2016 and ..._2021], the data downloaded from the ABS Table Builder was already based on LGA boundaries. 

```{r add_groupings_DZN_LGA, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.cap="Greater Perth: Heritage, North-south and Outer East groupings", cache=TRUE}


#join grouping to JTW data frames
Greater_Perth_JTW_by_DZ_and_LGA_2016 <- left_join(Greater_Perth_JTW_by_DZ_and_LGA_2016, LGA_to_group, by = "lga_name_2021")
Greater_Perth_JTW_by_DZ_and_LGA_2021 <- left_join(Greater_Perth_JTW_by_DZ_and_LGA_2021, LGA_to_group, by = "lga_name_2021")

```

I have also downloaded the age and employment data for all of WA's LGAs so that it is possible to calculate population and employed population for each of the Heritage, North-south and Outer east groupings. 

```{r load_employment_and_age_data, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.cap="Greater Perth: Heritage, North-south and Outer East groupings", cache=TRUE}

library(readr)
X2016_WA_age_by_LGA <- read_csv("01 data/2016_WA_Age_by_LGA.csv", skip = 8)
X2016_WA_employment_by_LGA <- read_csv("01 data/2016_WA_employment_by_LGA.csv", skip=8)
X2021_WA_age_by_LGA <- read_csv("01 data/2021_WA_Age_by_LGA.csv", skip=8)
X2021_WA_employment_by_LGA <- read_csv("01 data/2021_WA_Employment_by_LGA.csv", skip=8)

#drop empty first row and last 5 rows, and last 2 columns
X2016_WA_age_by_LGA <- X2016_WA_age_by_LGA[2:(nrow(X2016_WA_age_by_LGA)-5), 1:(ncol(X2016_WA_age_by_LGA)-2)]
X2016_WA_employment_by_LGA <- X2016_WA_employment_by_LGA[2:(nrow(X2016_WA_employment_by_LGA)-5), 1:(ncol(X2016_WA_employment_by_LGA)-2)]
X2021_WA_age_by_LGA <- X2021_WA_age_by_LGA[2:(nrow(X2021_WA_age_by_LGA)-5), 1:(ncol(X2021_WA_age_by_LGA)-2)]
X2021_WA_employment_by_LGA <- X2021_WA_employment_by_LGA[2:(nrow(X2021_WA_employment_by_LGA)-5), 1:(ncol(X2021_WA_employment_by_LGA)-2)]

#set characters to numeric for column two
#Whoops, downloaded the by individual years data instead of the 10 year groupings
X2016_WA_age_by_LGA$`0 years` <- as.numeric(unlist(X2016_WA_age_by_LGA[,2]))
X2016_WA_employment_by_LGA$`Fully engaged`<- as.numeric(unlist(X2016_WA_employment_by_LGA[,2]))
X2021_WA_age_by_LGA$`0-9 years` <- as.numeric(unlist(X2021_WA_age_by_LGA[,2]))
X2021_WA_employment_by_LGA$`Fully engaged`<- as.numeric(unlist(X2021_WA_employment_by_LGA[,2]))

#set names the same
names(X2016_WA_age_by_LGA) <- 
  c("lga_name_2021", 
    names(X2016_WA_age_by_LGA[,2:ncol(X2016_WA_age_by_LGA)]))
names(X2016_WA_employment_by_LGA) <- 
  c("lga_name_2021", 
    names(X2016_WA_employment_by_LGA[,2:ncol(X2016_WA_employment_by_LGA)]))
names(X2021_WA_age_by_LGA) <- 
  c("lga_name_2021", 
    names(X2021_WA_age_by_LGA[,2:ncol(X2021_WA_age_by_LGA)]))
names(X2021_WA_employment_by_LGA) <- 
  c("lga_name_2021", 
    names(X2021_WA_employment_by_LGA[,2:ncol(X2021_WA_employment_by_LGA)]))


#Remove (C) and similar from lga names
X2016_WA_age_by_LGA$lga_name_2021 <- sub(" (*).*","", X2016_WA_age_by_LGA$lga_name_2021)
X2016_WA_employment_by_LGA$lga_name_2021 <- sub(" (*).*","", X2016_WA_employment_by_LGA$lga_name_2021)
X2021_WA_age_by_LGA$lga_name_2021 <- sub(" (*).*","", X2021_WA_age_by_LGA$lga_name_2021)
X2021_WA_employment_by_LGA$lga_name_2021 <- sub(" (*).*","", X2021_WA_employment_by_LGA$lga_name_2021)




#join grouping to employment and age data frames
X2016_WA_age_by_LGA <- left_join(X2016_WA_age_by_LGA, LGA_to_group, by = "lga_name_2021")
X2016_WA_employment_by_LGA <- left_join(X2016_WA_employment_by_LGA, LGA_to_group, by = "lga_name_2021")
X2021_WA_age_by_LGA <- left_join(X2021_WA_age_by_LGA, LGA_to_group, by = "lga_name_2021")
X2021_WA_employment_by_LGA <- left_join(X2021_WA_employment_by_LGA, LGA_to_group, by = "lga_name_2021")


```




# 3.0 Results

## 3.1 Aggregate for Greater Perth
```{r Greater_Perth_JTW_aggregate, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE, fig.cap="Greater Perth, journey to work mode share, 2021 and 2016 censuses"}

Greater_Perth_JTW_by_destination_2016_no_geometry <- Greater_Perth_JTW_by_destination_2016 %>% st_drop_geometry()
Greater_Perth_JTW_by_destination_2021_no_geometry <- Greater_Perth_JTW_by_destination_2021 %>% st_drop_geometry()
Greater_Perth_SA1_UR_by_MTW15P_2016_no_geometry <- Greater_Perth_SA1_UR_by_MTW15P_2016 %>% st_drop_geometry()
Greater_Perth_SA1_UR_by_MTW15P_2021_no_geometry <- Greater_Perth_SA1_UR_by_MTW15P_2021 %>% st_drop_geometry()

#calculate aggregates for everyone with a usual residence in perth
Aggregate_JTW_2016_2021 <- tibble(Greater_Perth_SA1_UR_by_MTW15P_2016_no_geometry[,1:17] %>% adorn_totals() %>% tail(n=1))
Aggregate_JTW_2016_2021 <- add_row(Aggregate_JTW_2016_2021, Greater_Perth_SA1_UR_by_MTW15P_2021_no_geometry[,1:17] %>% adorn_totals() %>% tail(n=1))

Aggregate_JTW_2016_2021$Year <- c("2016", "2021")

#combine modes to obtain PT, private vehicle (drive), private vehicle (passenger)  and non-motorised columns
Aggregate_JTW_2016_2021$`Private vehicle (drive)` <- Aggregate_JTW_2016_2021$`Car, as driver` + Aggregate_JTW_2016_2021$Truck + Aggregate_JTW_2016_2021$Motorbike  

Aggregate_JTW_2016_2021$`Private vehicle (passenger)` <- Aggregate_JTW_2016_2021$`Car, as passenger` + Aggregate_JTW_2016_2021$Taxi  

Aggregate_JTW_2016_2021$Transit <- Aggregate_JTW_2016_2021$Train + Aggregate_JTW_2016_2021$Bus + Aggregate_JTW_2016_2021$Ferry + Aggregate_JTW_2016_2021$Tram

Aggregate_JTW_2016_2021$`Non-motorised` <- Aggregate_JTW_2016_2021$Bicycle + Aggregate_JTW_2016_2021$`Walked only`

#Round all to whole number of people (as correspondence to convert 2016 to 2021 SA1s resulted in some fractional people)
Aggregate_JTW_2016_2021 <-Aggregate_JTW_2016_2021 %>% mutate_if(is.numeric, round, digits = 0)

#pivot_longer 
Aggregate_JTW_2016_2021_summary_longer <- pivot_longer(
  Aggregate_JTW_2016_2021[, c("Year", "Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other mode", "Worked at home")], 
  cols = c("Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other mode", "Worked at home"), 
  names_to = "Mode or activity",
  values_to = "People"
)

#Round to whole number of people (as the correspondence to convert 2016 to 2021 SA1s resulted in some fractional people)
#Aggregate_JTW_2016_2021_summary_longer$People <- round(Aggregate_JTW_2016_2021_summary_longer$People, digits = 0)

#turn mode into a factor to get a specific order
Aggregate_JTW_2016_2021_summary_longer$`Mode or activity` <- factor( Aggregate_JTW_2016_2021_summary_longer$`Mode or activity`, levels = c("Worked at home", "Other mode", "Non-motorised", "Transit", "Private vehicle (passenger)", "Private vehicle (drive)"))

p <- ggbarstats(
  Aggregate_JTW_2016_2021_summary_longer[,], 
  x = `Mode or activity`,
  y = Year,
  counts = People
)

p

kable(untabyl(Aggregate_JTW_2016_2021[, c("Year", "Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other mode", "Worked at home")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares, persons with a usual residence in Greater Perth, 2016 and 2021 censuses"
)

```
The changes in mode/activity share are small, but statistically significant 
```{r extract_stats1 , echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE, fig.cap="Greater Perth, journey to work mode share, 2021 and 2016 censuses, transit modes"}
extract_caption(p)

```


```{r Greater_Perth_JTW_aggregate_transit, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE, fig.cap="Greater Perth, journey to work mode share, 2021 and 2016 censuses, transit modes"}

#pivot_longer 
Aggregate_JTW_2016_2021_transit_longer <- pivot_longer(
  Aggregate_JTW_2016_2021[, c("Year", "Train", "Bus", "Ferry")], 
  cols = c("Train", "Bus", "Ferry"), 
  names_to = "Mode",
  values_to = "People"
)

#Round to whole number of people (as the correspondence to convert 2016 to 2021 SA1s resulted in some fractional people)
#Aggregate_JTW_2016_2021_summary_longer$People <- round(Aggregate_JTW_2016_2021_summary_longer$People, digits = 0)

#turn mode into a factor to get a specific order
Aggregate_JTW_2016_2021_transit_longer$`Mode` <- factor( Aggregate_JTW_2016_2021_transit_longer$`Mode`, levels = c("Bus", "Train", "Ferry"))

p <- ggbarstats(
  Aggregate_JTW_2016_2021_transit_longer[,], 
  x = `Mode`,
  y = Year,
  counts = People
)

p

kable(untabyl(Aggregate_JTW_2016_2021[, c("Year", "Train", "Bus", "Ferry")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares, persons with a usual residence in Greater Perth, 2016 and 2021 censuses, transit modes"
)

```

The changes in mode/activity share are small, but statistically significant 
```{r extract_stats2 , echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE, fig.cap="Greater Perth, journey to work mode share, 2021 and 2016 censuses, transit modes"}
extract_caption(p)

```


## 3.2 Disaggregate (Heritage, N-S, Outer east)

```{r Greater_Perth_JTW_disaggregate, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE, fig.cap="Heritage, North-south and Outer East groupings, journey to work mode share, 2021 and 2016 censuses"}

Greater_Perth_SA1_UR_by_MTW15P_2016_no_geometry_disaggregate <- split (Greater_Perth_SA1_UR_by_MTW15P_2016_no_geometry,Greater_Perth_SA1_UR_by_MTW15P_2016_no_geometry$grouping)

Greater_Perth_SA1_UR_by_MTW15P_2021_no_geometry_disaggregate <- split (Greater_Perth_SA1_UR_by_MTW15P_2021_no_geometry, Greater_Perth_SA1_UR_by_MTW15P_2021_no_geometry$grouping)

##calculate for everyone with a usual residence in perth, by grouping
#2016
Group_JTW_2016 <- lapply(
  Greater_Perth_SA1_UR_by_MTW15P_2016_no_geometry_disaggregate,  
  function(x) x%>% 
    dplyr::select(sa1_code_2021, Train, Bus, Ferry, Tram, Taxi, "Car, as driver", "Car, as passenger", "Truck", "Motorbike", "Bicycle", "Walked only", "Other mode", "Worked at home", "Not stated", "Not applicable")
)
Group_JTW_2016 <- Group_JTW_2016  %>% 
                    adorn_totals() 
Group_JTW_2016 <- lapply(
  Group_JTW_2016,  
  function(x) x%>% 
    tail(n=1)
)
#Add year as 2016
f <- function (data, name){
  data$Year <- "2016"
  data
}
Group_JTW_2016 <- Map(f, Group_JTW_2016, names(Group_JTW_2016)) 


#2021
Group_JTW_2021 <- lapply(
  Greater_Perth_SA1_UR_by_MTW15P_2021_no_geometry_disaggregate,  
  function(x) x%>% 
    dplyr::select(sa1_code_2021, Train, Bus, Ferry, Tram, Taxi, "Car, as driver", "Car, as passenger", "Truck", "Motorbike", "Bicycle", "Walked only", "Other mode", "Worked at home", "Not stated", "Not applicable")
)
Group_JTW_2021 <- Group_JTW_2021  %>% 
                    adorn_totals() 
Group_JTW_2021 <- lapply(
  Group_JTW_2021,  
  function(x) x%>% 
    tail(n=1)
)

#Add year as 2021
f <- function (data, name){
  data$Year <- "2020"
  data
}
Group_JTW_2021 <- Map(f, Group_JTW_2021, names(Group_JTW_2021)) 



#NEXT combine into one 2016+2021 dataframe
#Combine 2016 and 2021 rows
f <- function (x, y){
  data <- add_row(x, y)
  data
}
Group_JTW_2016_2021 <- Map(f, Group_JTW_2016, Group_JTW_2021) 


#combine modes to obtain PT, private vehicle (drive), private vehicle (passenger)  and non-motorised columns
f <- function (x){
  x$`Private vehicle (drive)` <- 
    x$`Car, as driver` + 
    x$Truck + 
    x$Motorbike  
  x$`Private vehicle (passenger)` <- 
    x$`Car, as passenger` + 
    x$Taxi  
  x$Transit <- 
    x$Train + 
    x$Bus + 
    x$Ferry + 
    x$Tram
  x$`Non-motorised` <- 
    x$Bicycle + 
    x$`Walked only`
#Round all to whole number of people (as correspondence to convert 2016 to 2021 SA1s resulted in some fractional people)
  x <-x %>% mutate_if(is.numeric, round, digits = 0)
}
Group_JTW_2016_2021 <- Map(f, Group_JTW_2016_2021) 

#pivot_longer
f <- function (x){pivot_longer(
    x[, c("Year", "Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other mode", "Worked at home")], 
    cols = c("Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other mode", "Worked at home"), 
    names_to = "Mode or activity",
    values_to = "People"
  )
}
Group_JTW_2016_2021_longer <- Map(f, Group_JTW_2016_2021) 
  
  
  #turn mode into a factor to get a specific order
f <- function (x){
  x$`Mode or activity` <- factor(x$`Mode or activity`, levels = c("Worked at home", "Other mode", "Non-motorised", "Transit", "Private vehicle (passenger)", "Private vehicle (drive)"))
  x
}

Group_JTW_2016_2021_longer <- Map(f, Group_JTW_2016_2021_longer) 


p <- ggbarstats(
  as.tibble(Group_JTW_2016_2021_longer[[1]]), 
  x = `Mode or activity`,
  y = Year,
  counts = People
)

p



kable(untabyl( as.tibble(Group_JTW_2016_2021[[1]])[, c("Year", "Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other mode", "Worked at home")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares, persons with a usual residence in Heritage zones, 2016 and 2021 censuses"
)


p <- ggbarstats(
  as.tibble(Group_JTW_2016_2021_longer[[2]]), 
  x = `Mode or activity`,
  y = Year,
  counts = People
)

p
kable(untabyl(as.tibble(Group_JTW_2016_2021[[2]])[, c("Year", "Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other mode", "Worked at home")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares, persons with a usual residence in North-south grouping, 2016 and 2021 censuses"
)


p <- ggbarstats(
  as.tibble(Group_JTW_2016_2021_longer[[3]]), 
  x = `Mode or activity`,
  y = Year,
  counts = People
)

p



kable(untabyl(as.tibble(Group_JTW_2016_2021[[3]])[, c("Year", "Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other mode", "Worked at home")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares, persons with a usual residence in Outer east grouping, 2016 and 2021 censuses"
)


```
The changes in mode/activity share are small, but statistically significant. For the: 

- Heritage grouping (p < 0.01): private vehicle (drive) -0.3%, WFH +0.1%, non-motorised +0.2%;
- North-south grouping (p = 0.02): private vehicle (drive) -0.1%, WFH +0.1%, non-motorised +0.1%;  and
- Outer-east grouping (p < 0.01): private vehicle (drive) -0.2%, non-motorised +0.1%, WFH +0.3%.


```{r Greater_Perth_JTW_disaggregate_transit, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE, fig.cap="Greater Perth, journey to work mode share, 2021 and 2016 censuses, transit modes"}

f <- function (x){
  df <- pivot_longer(
  x[, c("Year", "Train", "Bus")], 
  cols = c("Train", "Bus"), 
  names_to = "Mode",
  values_to = "People"
)
 
  df$`Mode` <- factor(df$`Mode`, levels = c("Bus", "Train"))
  
df  
}
Group_JTW_2016_2021_transit_longer <- Map(f, Group_JTW_2016_2021) 


p <- ggbarstats(
  as.tibble(Group_JTW_2016_2021_transit_longer[[1]]), 
  x = `Mode`,
  y = Year,
  counts = People
)
p

kable(untabyl( as.tibble(Group_JTW_2016_2021[[1]])[, c("Year", "Train", "Bus")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares, persons with a usual residence in Heritage zones, 2016 and 2021 censuses"
)

p <- ggbarstats(
  as.tibble(Group_JTW_2016_2021_transit_longer[[2]]), 
  x = `Mode`,
  y = Year,
  counts = People
)

p



kable(untabyl( as.tibble(Group_JTW_2016_2021[[2]])[, c("Year", "Train", "Bus")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares, persons with a usual residence in North-south grouping, 2016 and 2021 censuses"
)

p <- ggbarstats(
  as.tibble(Group_JTW_2016_2021_transit_longer[[3]]), 
  x = `Mode`,
  y = Year,
  counts = People
)

p



kable(untabyl( as.tibble(Group_JTW_2016_2021[[3]])[, c("Year", "Train", "Bus")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares, persons with a usual residence in Outer-east grouping, 2016 and 2021 censuses"
)


```

No significant changes in train vs bus split for the Heritage grouping (p = 0.72), North-south grouping (p= 0.08) or  Outer-east grouping (p=0.64).

It would be good to also know how total population and employment has changes in each of the LGA groupings

```{r Greater_Perth_population_and_employment_change_by_grouping, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE}

Heritage2016 <- X2016_WA_age_by_LGA %>% 
        filter(grouping == "Heritage") %>% 
        adorn_totals(where = c("row", "col")) %>%
        tail(n=1)
North_south2016 <- X2016_WA_age_by_LGA %>% 
        filter(grouping == "North-south") %>% 
        adorn_totals(where = c("row", "col")) %>%
        tail(n=1)
Outer_east2016 <- X2016_WA_age_by_LGA %>% 
        filter(grouping == "Outer east") %>% 
        adorn_totals(where = c("row", "col")) %>%
        tail(n=1)

Heritage2021 <- X2021_WA_age_by_LGA %>% 
        filter(grouping == "Heritage") %>% 
        adorn_totals(where = c("row", "col")) %>%
        tail(n=1)
North_south2021 <- X2021_WA_age_by_LGA %>% 
        filter(grouping == "North-south") %>% 
        adorn_totals(where = c("row", "col")) %>%
        tail(n=1)
Outer_east2021 <- X2021_WA_age_by_LGA %>% 
        filter(grouping == "Outer east") %>% 
        adorn_totals(where = c("row", "col")) %>%
        tail(n=1)

population <- tibble (Year = c("2016", "2021"), Heritage = c(Heritage2016$Total, Heritage2021$Total), North_south = c(North_south2016$Total, North_south2021$Total), Outer_east = c(Outer_east2016$Total, Outer_east2021$Total))


kable(population %>% 
        adorn_totals(where = "col") %>%
        adorn_percentages("row") %>%
        adorn_pct_formatting() %>%
        adorn_ns(),
      caption = "Population by grouping, 2016 and 2021"
)


Heritage2016 <- X2016_WA_employment_by_LGA[,c(1:4, 8)] %>% 
        filter(grouping == "Heritage") %>% 
        adorn_totals(where = c("row", "col")) %>%
        tail(n=1)
North_south2016 <- X2016_WA_employment_by_LGA[,c(1:4, 8)] %>% 
        filter(grouping == "North-south") %>% 
        adorn_totals(where = c("row", "col")) %>%
        tail(n=1)
Outer_east2016 <- X2016_WA_employment_by_LGA[,c(1:4, 8)] %>% 
        filter(grouping == "Outer east") %>% 
        adorn_totals(where = c("row", "col")) %>%
        tail(n=1)

Heritage2021 <- X2021_WA_employment_by_LGA[,c(1:4, 8)] %>% 
        filter(grouping == "Heritage") %>% 
        adorn_totals(where = c("row", "col")) %>%
        tail(n=1)
North_south2021 <- X2021_WA_employment_by_LGA[,c(1:4, 8)] %>% 
        filter(grouping == "North-south") %>% 
        adorn_totals(where = c("row", "col")) %>%
        tail(n=1)
Outer_east2021 <- X2021_WA_employment_by_LGA[,c(1:4, 8)] %>% 
        filter(grouping == "Outer east") %>% 
        adorn_totals(where = c("row", "col")) %>%
        tail(n=1)

employment <- tibble (Year = c("2016", "2021"), Heritage = c(Heritage2016$Total, Heritage2021$Total), North_south = c(North_south2016$Total, North_south2021$Total), Outer_east = c(Outer_east2016$Total, Outer_east2021$Total))


kable(employment %>% 
        adorn_totals(where = "col") %>%
        adorn_percentages("row") %>%
        adorn_pct_formatting() %>%
        adorn_ns(),
      caption = "Employed population by grouping, 2016 and 2021"
)


```


## 3.3 CBD vs non-CBD


```{r Map_CBD_vs_non_CBD, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE, fig.cap="Perth CBD vs rest of Greater Perth, 2021 destination zones"}

CBD_sa1_codes <- tibble (sa1_code = c("50302129706", "50302129703", "50302129714", "50302129704", "50302129707", "50302129715", "50302129713", "50302129711", "50302129724", "50302129720", "50302129709", "50302129708", "50302129729", "50302129726", "50302129722"), 
                         Location = "CBD"
                         )

CBD_dz_codes <- tibble (dz_code_2021 = c("512970037", "512970047", "512970035", "512970039", "512970042", "512970025", "512970033", "512970028", "512970020", "512970023", "512970011", "512970038", "512970032", "512970027", "512970046", "512970041", "512970036", "512970031", "512970049", "512970045", "512970040", "512970034", "512970048", "512970043", "512970030", "512970043", "512970048", "512970050", "512970044", "512970001"), Location = "CBD"
                         )
CBD_dz_codes2016 <- tibble (dz_code_2021 = c("510411093", "510411106", "510411090", "510411095", "510411078", "510411071", "510411056", "510411076", "510411081", "510411087", "510411098", "510411094", "510411086", "510411080", "510411085", "510411091", "510411097", "51041102", "510411108", "510411101", "510411096", "510411088", "510411084", "510411099", "510411107", "510411112", "510411109", "510411100", "510411102"), Location = "CBD"
                         )


#Join CBD zones with Greater Perth map data



#DZ2016_map_data <- left_join((dz2016 %>%
#  filter(state_name_2016 == "Western Australia")), CBD_dz_codes2016, by = "dz_code_2016")

#DZ2021_map_data <- left_join(DZ2021_map_data %>%
#  filter(gcc_name_2021 == "Greater Perth"), CBD_dz_codes)

#Change NA to non-CBD for all other DZ in Greater Perth
#DZ2016_map_data$Location <- replace_na(DZ2016_map_data$Location, "non-CBD")
#DZ2021_map_data$Location <- replace_na(DZ2021_map_data$Location, "non-CBD")



#Map destination zones
#map <- DZ2016_map_data %>%
#   ggplot() +
#  geom_sf(aes(geometry = geometry,  # use the geometry variable
#              fill = Location),     # fill by whether it is CBD or non-CBD
#          lwd = 0,                  # remove borders
#          show.legend = TRUE) +    # keep legend
# # geom_point(aes(cent_long,
#  #               cent_lat),        # use the centroid long (x) and lats (y)
#   #          colour = "white") +    # make the points white
#  theme_void() +                    # clears other plot elements
#  coord_sf()

#map



#Map destination zones
#map <- DZ2016_map_data %>%
#  filter(sa2_name_2016 == "Perth (West) - Northbridge" | sa2_name_2016 == "East Perth") %>%
#   ggplot() +
#  geom_sf(aes(geometry = geometry,  # use the geometry variable
 #             fill = Location),     # fill by whether it is CBD or non-CBD
#          lwd = 0,                  # remove borders
 #         show.legend = TRUE) +    # keep legend
 ## geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
#  theme_void() +                    # clears other plot elements
#  coord_sf()

#map


#DZ2016_map_data <- left_join((dz2016 %>%
#  filter(state_name_2016 == "Western Australia")), CBD_dz_codes2016, by = "dz_code_2016")

#DZ2021_map_data <- left_join(DZ2021_map_data %>%
#  filter(gcc_name_2021 == "Greater Perth"), CBD_dz_codes)

#Change NA to non-CBD for all other DZ in Greater Perth
#DZ2016_map_data$Location <- replace_na(DZ2016_map_data$Location, "non-CBD")
#DZ2021_map_data$Location <- replace_na(DZ2021_map_data$Location, "non-CBD")

#Map destination zones
#map <- DZ2016_map_data %>%
#   ggplot() +
#  geom_sf(aes(geometry = geometry,  # use the geometry variable
#              fill = Location),     # fill by whether it is CBD or non-CBD
#          lwd = 0,                  # remove borders
#          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
#  theme_void() +                    # clears other plot elements
#  coord_sf()

#map



#Map destination zones
#map <- DZ2016_map_data %>%
#  filter(sa2_name_2016 == "Perth City") %>%
#   ggplot() +
#  geom_sf(aes(geometry = geometry,  # use the geometry variable
#              fill = Location),     # fill by whether it is CBD or non-CBD
#          lwd = 0,                  # remove borders
#          show.legend = TRUE) +    # keep legend
# # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
#  theme_void() +                    # clears other plot elements
 # coord_sf()

#map




#Map destination zones
#map <- DZ2021_map_data %>%
 #  ggplot() +
#  geom_sf(aes(geometry = geometry,  # use the geometry variable
 #             fill = Location),     # fill by whether it is CBD or non-CBD
#          lwd = 0,                  # remove borders
 #         show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
 # theme_void() +                    # clears other plot elements
#  coord_sf()

#map



#Map destination zones
#map <- DZ2021_map_data %>%
#  filter(sa2_name_2021.x == "Perth (West) - Northbridge" | sa2_name_2021.x == "East Perth") %>%
 #  ggplot() +
#  geom_sf(aes(geometry = geometry,  # use the geometry variable
 #             fill = Location),     # fill by whether it is CBD or non-CBD
  #        lwd = 0,                  # remove borders
  #        show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
#  theme_void() +                    # clears other plot elements
#  coord_sf()

#map



```

### 3.3.1 Aggregate for Greater Perth

```{r Greater_Perth_JTW_aggregate_CBD_vs_non_CBD, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE, fig.cap="Perth CBD vs rest of Greater Perth, journey to work mode share, 2021 and 2016 censuses"}
#Greater_Perth_JTW_by_DZ_and_LGA_2016_holding <- Greater_Perth_JTW_by_DZ_and_LGA_2016
#Greater_Perth_JTW_by_DZ_and_LGA_2021_holding <- Greater_Perth_JTW_by_DZ_and_LGA_2021

#Greater_Perth_JTW_by_DZ_and_LGA_2016 <- Greater_Perth_JTW_by_DZ_and_LGA_2016_holding

#Join CBD zones with Greater Perth map data
Greater_Perth_JTW_by_DZ_and_LGA_2016 <- left_join(Greater_Perth_JTW_by_DZ_and_LGA_2016, CBD_dz_codes2016, by = "dz_code_2021")
Greater_Perth_JTW_by_DZ_and_LGA_2021 <- left_join(Greater_Perth_JTW_by_DZ_and_LGA_2021, CBD_dz_codes, by = "dz_code_2021")

#Change NA to non-CBD for all other DZ in Western Australia
Greater_Perth_JTW_by_DZ_and_LGA_2016$Location <- Greater_Perth_JTW_by_DZ_and_LGA_2016$Location %>% replace_na("non-CBD")
Greater_Perth_JTW_by_DZ_and_LGA_2021$Location <- Greater_Perth_JTW_by_DZ_and_LGA_2021$Location %>% replace_na("non-CBD")

#Restrict to only include Greater Perth LGAs
Greater_Perth_JTW_by_DZ_and_LGA_2016 <- Greater_Perth_JTW_by_DZ_and_LGA_2016[Greater_Perth_JTW_by_DZ_and_LGA_2016$lga_name_2021 %in% LGA_to_group$lga_name_2021 ,]
Greater_Perth_JTW_by_DZ_and_LGA_2021 <- Greater_Perth_JTW_by_DZ_and_LGA_2021[Greater_Perth_JTW_by_DZ_and_LGA_2021$lga_name_2021 %in% LGA_to_group$lga_name_2021 ,]

#Match taxi and tram column names
names(Greater_Perth_JTW_by_DZ_and_LGA_2016) <- c("lga_name_2021", "dz_code_2021", "Train", "Bus", "Ferry","Tram/light rail", "Taxi/ride-share service", "Car, as driver", "Car, as passenger", "Truck", "Motorbike/scooter", "Bicycle", "Walked only", "Other Mode", "Worked at home", "Did not go to work", "Not stated", "Not applicable", "grouping", "Location")  

#calculate aggregates for everyone travelling to CBD
Aggregate_JTW_2016_2021 <- tibble(Greater_Perth_JTW_by_DZ_and_LGA_2016 %>%
                                  filter(Location == "CBD") %>% 
                                    adorn_totals() %>% tail(n=1))
Aggregate_JTW_2016_2021 <- add_row(Aggregate_JTW_2016_2021, Greater_Perth_JTW_by_DZ_and_LGA_2021 %>%
                                  filter(Location == "CBD") %>% 
                                    adorn_totals() %>% tail(n=1))

Aggregate_JTW_2016_2021$Year <- c("2016", "2021")
Aggregate_JTW_2016_2021$Location <- c("CBD", "CBD")

#calculate aggregates for everyone travelling to CBD
Aggregate_JTW_2016_2021 <- add_row(Aggregate_JTW_2016_2021, Greater_Perth_JTW_by_DZ_and_LGA_2016  %>%
                                  filter(Location == "non-CBD") %>% 
                                    adorn_totals() %>% tail(n=1))
Aggregate_JTW_2016_2021 <- add_row(Aggregate_JTW_2016_2021, Greater_Perth_JTW_by_DZ_and_LGA_2021 %>%
                                  filter(Location == "non-CBD") %>% 
                                    adorn_totals() %>% tail(n=1))

Aggregate_JTW_2016_2021$Year <- c("2016", "2021", "2016", "2021")
Aggregate_JTW_2016_2021$Location <- c("CBD", "CBD", "non-CBD", "non-CBD")




#combine modes to obtain PT, private vehicle (drive), private vehicle (passenger)  and non-motorised columns
Aggregate_JTW_2016_2021$`Private vehicle (drive)` <- Aggregate_JTW_2016_2021$`Car, as driver` + Aggregate_JTW_2016_2021$Truck + Aggregate_JTW_2016_2021$`Motorbike/scooter`  

Aggregate_JTW_2016_2021$`Private vehicle (passenger)` <- Aggregate_JTW_2016_2021$`Car, as passenger` + Aggregate_JTW_2016_2021$`Taxi/ride-share service`  

Aggregate_JTW_2016_2021$Transit <- Aggregate_JTW_2016_2021$Train + Aggregate_JTW_2016_2021$Bus + Aggregate_JTW_2016_2021$Ferry + Aggregate_JTW_2016_2021$`Tram/light rail`

Aggregate_JTW_2016_2021$`Non-motorised` <- Aggregate_JTW_2016_2021$Bicycle + Aggregate_JTW_2016_2021$`Walked only`

#Round all to whole number of people (as correspondence to convert 2016 to 2021 SA1s resulted in some fractional people)
Aggregate_JTW_2016_2021 <-Aggregate_JTW_2016_2021 %>% mutate_if(is.numeric, round, digits = 0)



##CBD only
Aggregate_JTW_2016_2021_CBD <- Aggregate_JTW_2016_2021 %>% filter(Location == "CBD")
#pivot_longer for CBD
Aggregate_JTW_2016_2021_summary_longer <- pivot_longer(
  Aggregate_JTW_2016_2021_CBD[, c("Year", "Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other Mode", "Worked at home")], 
  cols = c("Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other Mode", "Worked at home"), 
  names_to = "Mode or activity",
  values_to = "People"
)

#Round to whole number of people (as the correspondence to convert 2016 to 2021 SA1s resulted in some fractional people)
#Aggregate_JTW_2016_2021_summary_longer$People <- round(Aggregate_JTW_2016_2021_summary_longer$People, digits = 0)

#turn mode into a factor to get a specific order
Aggregate_JTW_2016_2021_summary_longer$`Mode or activity` <- factor( Aggregate_JTW_2016_2021_summary_longer$`Mode or activity`, levels = c("Worked at home", "Other Mode", "Non-motorised", "Transit", "Private vehicle (passenger)", "Private vehicle (drive)"))

p <- ggbarstats(
  Aggregate_JTW_2016_2021_summary_longer[,], 
  x = `Mode or activity`,
  y = Year,
  counts = People
)

p

kable(untabyl(Aggregate_JTW_2016_2021_CBD[, c("Year", "Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other Mode", "Worked at home")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares to CBD destinations, persons with a usual residence in Greater Perth, 2016 and 2021 censuses"
)



##non-CBD only
Aggregate_JTW_2016_2021_non_CBD <- Aggregate_JTW_2016_2021 %>% filter(Location == "non-CBD")
#pivot_longer 
Aggregate_JTW_2016_2021_summary_longer <- pivot_longer(
  Aggregate_JTW_2016_2021_non_CBD[, c("Year", "Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other Mode", "Worked at home")], 
  cols = c("Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other Mode", "Worked at home"), 
  names_to = "Mode or activity",
  values_to = "People"
)

#Round to whole number of people (as the correspondence to convert 2016 to 2021 SA1s resulted in some fractional people)
#Aggregate_JTW_2016_2021_summary_longer$People <- round(Aggregate_JTW_2016_2021_summary_longer$People, digits = 0)

#turn mode into a factor to get a specific order
Aggregate_JTW_2016_2021_summary_longer$`Mode or activity` <- factor( Aggregate_JTW_2016_2021_summary_longer$`Mode or activity`, levels = c("Worked at home", "Other Mode", "Non-motorised", "Transit", "Private vehicle (passenger)", "Private vehicle (drive)"))

p <- ggbarstats(
  Aggregate_JTW_2016_2021_summary_longer[,], 
  x = `Mode or activity`,
  y = Year,
  counts = People
)

p

kable(untabyl(Aggregate_JTW_2016_2021_non_CBD[, c("Year", "Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other Mode", "Worked at home")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares to non-CBD destinations, persons with a usual residence in Greater Perth, 2016 and 2021 censuses"
)


```
The changes in mode/activity share are small, but statistically significant 


```{r Greater_Perth_JTW_aggregate_transit_CBD_vs_non_CBD, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE, fig.cap="Greater Perth, journey to work mode share, 2021 and 2016 censuses, transit modes"}

#pivot_longer 
Aggregate_JTW_2016_2021_transit_longer <- pivot_longer(
  Aggregate_JTW_2016_2021[, c("Year", "Train", "Bus")], 
  cols = c("Train", "Bus"), 
  names_to = "Mode",
  values_to = "People"
)

#Round to whole number of people (as the correspondence to convert 2016 to 2021 SA1s resulted in some fractional people)
#Aggregate_JTW_2016_2021_summary_longer$People <- round(Aggregate_JTW_2016_2021_summary_longer$People, digits = 0)

#turn mode into a factor to get a specific order
Aggregate_JTW_2016_2021_transit_longer$`Mode` <- factor( Aggregate_JTW_2016_2021_transit_longer$`Mode`, levels = c("Bus", "Train"))

p <- ggbarstats(
  Aggregate_JTW_2016_2021_transit_longer[,], 
  x = `Mode`,
  y = Year,
  counts = People
)

p

kable(untabyl(Aggregate_JTW_2016_2021[, c("Year", "Train", "Bus")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares, persons with a usual residence in Greater Perth, 2016 and 2021 censuses, transit modes"
)

```

### 3.3.2 Disaggregate (Heritage, N-S, Outer east)

```{r Greater_Perth_JTW_disaggregate_CBD_vs_non_CBD, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE, fig.cap="Greater Perth, journey to work mode share, 2021 and 2016 censuses"}

Greater_Perth_SA1_UR_by_MTW15P_2016_no_geometry_disaggregate <- split (Greater_Perth_SA1_UR_by_MTW15P_2016_no_geometry,Greater_Perth_SA1_UR_by_MTW15P_2016_no_geometry$grouping)

Greater_Perth_SA1_UR_by_MTW15P_2021_no_geometry_disaggregate <- split (Greater_Perth_SA1_UR_by_MTW15P_2021_no_geometry, Greater_Perth_SA1_UR_by_MTW15P_2021_no_geometry$grouping)

##calculate for everyone with a usual residence in perth, by grouping
#2016
Group_JTW_2016 <- lapply(
  Greater_Perth_SA1_UR_by_MTW15P_2016_no_geometry_disaggregate,  
  function(x) x%>% 
    dplyr::select(sa1_code_2021, Train, Bus, Ferry, Tram, Taxi, "Car, as driver", "Car, as passenger", "Truck", "Motorbike", "Bicycle", "Walked only", "Other mode", "Worked at home", "Not stated", "Not applicable")
)
Group_JTW_2016 <- Group_JTW_2016  %>% 
                    adorn_totals() 
Group_JTW_2016 <- lapply(
  Group_JTW_2016,  
  function(x) x%>% 
    tail(n=1)
)
#Add year as 2016
f <- function (data, name){
  data$Year <- "2016"
  data
}
Group_JTW_2016 <- Map(f, Group_JTW_2016, names(Group_JTW_2016)) 


#2021
Group_JTW_2021 <- lapply(
  Greater_Perth_SA1_UR_by_MTW15P_2021_no_geometry_disaggregate,  
  function(x) x%>% 
    dplyr::select(sa1_code_2021, Train, Bus, Ferry, Tram, Taxi, "Car, as driver", "Car, as passenger", "Truck", "Motorbike", "Bicycle", "Walked only", "Other mode", "Worked at home", "Not stated", "Not applicable")
)
Group_JTW_2021 <- Group_JTW_2021  %>% 
                    adorn_totals() 
Group_JTW_2021 <- lapply(
  Group_JTW_2021,  
  function(x) x%>% 
    tail(n=1)
)

#Add year as 2021
f <- function (data, name){
  data$Year <- "2020"
  data
}
Group_JTW_2021 <- Map(f, Group_JTW_2021, names(Group_JTW_2021)) 



#NEXT combine into one 2016+2021 dataframe
#Combine 2016 and 2021 rows
f <- function (x, y){
  data <- add_row(x, y)
  data
}
Group_JTW_2016_2021 <- Map(f, Group_JTW_2016, Group_JTW_2021) 


#combine modes to obtain PT, private vehicle (drive), private vehicle (passenger)  and non-motorised columns
f <- function (x){
  x$`Private vehicle (drive)` <- 
    x$`Car, as driver` + 
    x$Truck + 
    x$Motorbike  
  x$`Private vehicle (passenger)` <- 
    x$`Car, as passenger` + 
    x$Taxi  
  x$Transit <- 
    x$Train + 
    x$Bus + 
    x$Ferry + 
    x$Tram
  x$`Non-motorised` <- 
    x$Bicycle + 
    x$`Walked only`
#Round all to whole number of people (as correspondence to convert 2016 to 2021 SA1s resulted in some fractional people)
  x <-x %>% mutate_if(is.numeric, round, digits = 0)
}
Group_JTW_2016_2021 <- Map(f, Group_JTW_2016_2021) 

#pivot_longer
f <- function (x){pivot_longer(
    x[, c("Year", "Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other mode", "Worked at home")], 
    cols = c("Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other mode", "Worked at home"), 
    names_to = "Mode or activity",
    values_to = "People"
  )
}
Group_JTW_2016_2021_longer <- Map(f, Group_JTW_2016_2021) 
  
  
  #turn mode into a factor to get a specific order
f <- function (x){
  x$`Mode or activity` <- factor(x$`Mode or activity`, levels = c("Worked at home", "Other mode", "Non-motorised", "Transit", "Private vehicle (passenger)", "Private vehicle (drive)"))
  x
}

Group_JTW_2016_2021_longer <- Map(f, Group_JTW_2016_2021_longer) 


p <- ggbarstats(
  as.tibble(Group_JTW_2016_2021_longer[[1]]), 
  x = `Mode or activity`,
  y = Year,
  counts = People
)

p



kable(untabyl( as.tibble(Group_JTW_2016_2021[[1]])[, c("Year", "Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other mode", "Worked at home")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares, persons with a usual residence in Heritage zones, 2016 and 2021 censuses"
)


p <- ggbarstats(
  as.tibble(Group_JTW_2016_2021_longer[[2]]), 
  x = `Mode or activity`,
  y = Year,
  counts = People
)

p
kable(untabyl(as.tibble(Group_JTW_2016_2021[[2]])[, c("Year", "Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other mode", "Worked at home")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares, persons with a usual residence in Heritage zones, 2016 and 2021 censuses"
)


p <- ggbarstats(
  as.tibble(Group_JTW_2016_2021_longer[[3]]), 
  x = `Mode or activity`,
  y = Year,
  counts = People
)

p



kable(untabyl(as.tibble(Group_JTW_2016_2021[[3]])[, c("Year", "Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other mode", "Worked at home")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares, persons with a usual residence in Heritage zones, 2016 and 2021 censuses"
)


```
The changes in mode/activity share are small, but statistically significant. For the: 

- Heritage grouping (p < 0.01): private vehicle (drive) -0.3%, WFH +0.1%, non-motorised +0.2%;
- North-south grouping (p = 0.02): private vehicle (drive) -0.1%, WFH +0.1%, non-motorised +0.1%;  and
- Outer-east grouping (p < 0.01): private vehicle (drive) -0.2%, non-motorised +0.1%, WFH +0.3%.


```{r Greater_Perth_JTW_disaggregate_transit_CBD_vs_non_CBD, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE, fig.cap="Greater Perth, journey to work mode share, 2021 and 2016 censuses, transit modes"}

f <- function (x){
  df <- pivot_longer(
  x[, c("Year", "Train", "Bus")], 
  cols = c("Train", "Bus"), 
  names_to = "Mode",
  values_to = "People"
)
 
  df$`Mode` <- factor(df$`Mode`, levels = c("Bus", "Train"))
  
df  
}
Group_JTW_2016_2021_transit_longer <- Map(f, Group_JTW_2016_2021) 


p <- ggbarstats(
  as.tibble(Group_JTW_2016_2021_transit_longer[[1]]), 
  x = `Mode`,
  y = Year,
  counts = People
)
p

kable(untabyl( as.tibble(Group_JTW_2016_2021[[1]])[, c("Year", "Train", "Bus")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares, persons with a usual residence in Heritage zones, 2016 and 2021 censuses"
)

p <- ggbarstats(
  as.tibble(Group_JTW_2016_2021_transit_longer[[2]]), 
  x = `Mode`,
  y = Year,
  counts = People
)

p



kable(untabyl( as.tibble(Group_JTW_2016_2021[[2]])[, c("Year", "Train", "Bus")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares, persons with a usual residence in North-south grouping, 2016 and 2021 censuses"
)

p <- ggbarstats(
  as.tibble(Group_JTW_2016_2021_transit_longer[[3]]), 
  x = `Mode`,
  y = Year,
  counts = People
)

p



kable(untabyl( as.tibble(Group_JTW_2016_2021[[3]])[, c("Year", "Train", "Bus")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares, persons with a usual residence in Outer-east grouping, 2016 and 2021 censuses"
)


```

No significant changes in train vs bus split for the Heritage grouping (p = 0.72), North-south grouping (p= 0.08) or  Outer-east grouping (p=0.64).





# 4.0 Discussion

# 5.0 Conclusions

#References



```{r bib, include=FALSE}
# create a bib file for the R packages used in this document
knitr::write_bib(c('base', 'rmarkdown'), file = 'skeleton.bib')
```
