---
title: "Perth COVID-19 study; journey to work census analysis"
runningheader: "Perth COVID-19 study; journey to work census analysis" # only for pdf output
subtitle: "Perth COVID-19 study; journey to work census analysis" # only for html output
author: "Dr James Reynolds, Monash University Public Transport Research Group (PTRG)"
date: "`r Sys.Date()`"
output:
  tufte::tufte_html: default
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
bibliography: Perth_JTW_census_analysis.bib
link-citations: yes
---

```{r setup, include=FALSE}
library(tufte)
library(tidyverse)
library(sp)
library(ggplot2)
library(sf)
library(ASGS.foyer)
library(raster)
library(ggmap)
library(units)
library(absmapsdata)
library(readabs)
library(readr)
library(janitor)
library(scales)
library(ggstatsplot)
library(ggmap)
library(knitr)

# invalidate cache when the tufte version changes
knitr::opts_chunk$set(cache.extra = packageVersion('tufte'))
options(htmltools.dir.version = FALSE)
```

# 1.0 Introduction
The Monash University Public Transport Research Group is looking at changes in travel behaviour in Perth surrounding the COVID-19 pandemic. Part of this work involves examining the Australian Bureau of Statistics (ABS) journey-to-work data for the 2016 and 2021 censuses. Areas of interest are: 

- Aggregate Analysis for all of Greater Perth area

- Disaggregate Area Analysis for the three areas of Perth definied in previous PTRG work^[See Graham's sample size jottings worksheet.]: the North-south Group ^[City of Melville, City of South Perth, City of Stirling, City of Joondalup, City of Wanneroo, City of Cockburn, City of Kwinana, City of Rockingham, City of Murray and City of Mandurah.], the Heritage Group ^[City of Bayswater, City of Belmont, City of Canning, City of Fremantle, City of Nedlands, City of Perth, City of Subiaco, City of Vincent, Shire of Peppermint Grove, Town of Bassendean, Town of Cambridge, Town of Claremont, Town of Cottesloe, Town of East Fremantle, Town of Mosman Park, Town of Victoria Park and City of Gosnells.] and the Outer east^[City of Kalamunda, City of Swan, Shire of Mundaring, City of Armadale, and Shire of Serpentine-Jarrahdale.].

-	Perth CBD^[Using the WADoT Perth Greater CBD Transport Plan https://www.transport.wa.gov.au/mediaFiles/projects/PROJECT_I_Perth_Greater_CBD_Transport_Plan_map.pdf the Central Perth CBD generally consists of the 2021 Statistical Area 1 (SA1) zones of 50302129706, 50302129703, 50302129714, 50302129704, 50302129707, 50302129715, 50302129713, 50302129711, 50302129724, 50302129720, 50302129709, 50302129708, 50302129729, 50302129726 and 50302129722.] / Non-CBD-based Jobs 
  - Aggregate Analysis: comparing journeys to the CBD with journeys not to the CBD.
  - Disaggregate Spatial Analysis, again using the North-South, Heritage and Outer East groups. 


This working note details the process of collecting and reviewing the ABS data. It is structured as follows: the next section details the processing of the ABS data; Section 3 presents the results; followed by a brief discussion in Section 4; and conclusions in Section 5. 

# 2.0 Methods and data processing

The Journey-To-Work (JTW) data was extracted using the Table Builder on the ABS website. Data from 2016 and 2021 for Greater Perth was obtained. Join this with the Destination Zones allows mode shares to be mapped, as shown in the margin figure.

```{r load_abs_jtw_data, echo=FALSE, message = FALSE, warning=FALSE, fig.margin=TRUE, fig.cap="Greater Perth, car driver mode share by destination zone, 2016", cache=TRUE}

Greater_Perth_JTW_by_destination_2016 <- read_csv("01 data/Greater_Perth_JTW_by_destination_2016.csv", 
    skip = 8)
Greater_Perth_JTW_by_destination_2021 <- read_csv("01 data/Greater_Perth_JTW_by_destination_2021.csv", 
    skip = 8)

Greater_Perth_SA1_UR_by_MTW15P_2016 <- read_csv("01 data/Greater_Perth_SA1_UR_by_MTW15P_2016.csv", 
    skip = 8)

Greater_Perth_SA1_UR_by_MTW15P_2021 <- read_csv("01 data/Greater_Perth_SA1_UR_by_MTW15P_2021.csv", 
    skip = 8)



#remove first empty row and last 5 rows with copyright info
Greater_Perth_JTW_by_destination_2016 <- Greater_Perth_JTW_by_destination_2016[2:(nrow(Greater_Perth_JTW_by_destination_2016)-5),]
Greater_Perth_JTW_by_destination_2021<- Greater_Perth_JTW_by_destination_2021[2:(nrow(Greater_Perth_JTW_by_destination_2021)-5),]

Greater_Perth_SA1_UR_by_MTW15P_2016 <- Greater_Perth_SA1_UR_by_MTW15P_2016[2:(nrow(Greater_Perth_SA1_UR_by_MTW15P_2016)-5),]
Greater_Perth_SA1_UR_by_MTW15P_2021 <- Greater_Perth_SA1_UR_by_MTW15P_2021[2:(nrow(Greater_Perth_SA1_UR_by_MTW15P_2021)-5),]


#Convert Train column to numeric
Greater_Perth_JTW_by_destination_2016$Train <- as.numeric(Greater_Perth_JTW_by_destination_2016$Train)
Greater_Perth_JTW_by_destination_2021$Train <- as.numeric(Greater_Perth_JTW_by_destination_2021$Train)


#update first column name to be dz_code_2016
names(Greater_Perth_JTW_by_destination_2016) <- 
  c("dz_code_2016", 
    names(Greater_Perth_JTW_by_destination_2016[,2:ncol(Greater_Perth_JTW_by_destination_2016)]))
#Do same update first column name to be dz_code_2021
names(Greater_Perth_JTW_by_destination_2021) <- 
  c("dz_code_2021", 
    names(Greater_Perth_JTW_by_destination_2021[,2:ncol(Greater_Perth_JTW_by_destination_2021)]))
#Update first column name to be SA1_CODE_2016
names(Greater_Perth_SA1_UR_by_MTW15P_2016) <- 
  c("SA1_CODE_2016", 
    names(Greater_Perth_SA1_UR_by_MTW15P_2016[,2:ncol(Greater_Perth_SA1_UR_by_MTW15P_2016)]))
#Update first column name to be SA1_CODE_2021
names(Greater_Perth_SA1_UR_by_MTW15P_2021) <- 
  c("SA1_CODE_2021", 
    names(Greater_Perth_SA1_UR_by_MTW15P_2021[,2:ncol(Greater_Perth_SA1_UR_by_MTW15P_2021)]))



#Drop unneeded columns
Greater_Perth_JTW_by_destination_2016 <- tibble(Greater_Perth_JTW_by_destination_2016[,1:17])
Greater_Perth_JTW_by_destination_2021 <- tibble(Greater_Perth_JTW_by_destination_2021[,1:17])
Greater_Perth_SA1_UR_by_MTW15P_2016 <- tibble(Greater_Perth_SA1_UR_by_MTW15P_2016[,1:17])
Greater_Perth_SA1_UR_by_MTW15P_2021 <- tibble(Greater_Perth_SA1_UR_by_MTW15P_2021[,1:17])


```


The ABS provides correspondence files to convert between 2016 and 2021 destination zones, and between 2016 and 2021 SA1 zones. 

```{r load_abs_2021_2016_destination_zones_correspondence, echo=FALSE, fig.margin=TRUE, fig.cap="Perth 2021 destination zonea", cache=TRUE}

#Load DZ2021 to DZ2016 correspondence file
CG_DZN_2016_DZN_2021 <- read_csv("01 data/CG_DZN_2016_DZN_2021.csv")
CG_SA1_2016_SA1_2021 <- read_csv("01 data/CG_SA1_2016_SA1_2021.csv")

##convert 2016 DZ zones into 2021 DZ zones using the correspondence file from the ABS
#set so types are the same
CG_DZN_2016_DZN_2021$DZN_CODE_2016 <- as.character(CG_DZN_2016_DZN_2021$DZN_CODE_2016)
#Update first column name to be dz_code_2016 to match 
names(CG_DZN_2016_DZN_2021) <- 
  c("dz_code_2016", 
    names(CG_DZN_2016_DZN_2021[,2:ncol(CG_DZN_2016_DZN_2021)]))

#join
Greater_Perth_JTW_by_destination_2016 <- left_join(Greater_Perth_JTW_by_destination_2016, CG_DZN_2016_DZN_2021, by = "dz_code_2016")
#multiply mode numbers by RATIO_FROM_TO value
Greater_Perth_JTW_by_destination_2016[,22:37] <- Greater_Perth_JTW_by_destination_2016[,2:17] * Greater_Perth_JTW_by_destination_2016$RATIO_FROM_TO
#Drop unneeded columns
Greater_Perth_JTW_by_destination_2016 <- tibble(dz_code_2021 = Greater_Perth_JTW_by_destination_2016$DZN_CODE_2021, Greater_Perth_JTW_by_destination_2016[,22:37])


##convert 2016 SA1 zones into 2021 SA1 zones using the corrspondence file from the ABS
#For some reason the correspondence file provides SA1_MAINCODE_2016, rather than SA1_CODE_2016. The main code is a different number, but there is a correspondance in the SA1_2016_AUST file from https://www.abs.gov.au/AUSSTATS/abs@.nsf/DetailsPage/1270.0.55.001July%202016?OpenDocument
#So import that
SA1_2016_AUST <- read_csv("01 data/SA1_2016_AUST.csv")

#set so types are the same
CG_SA1_2016_SA1_2021$SA1_MAINCODE_2016 <- as.character(CG_SA1_2016_SA1_2021$SA1_MAINCODE_2016)
SA1_2016_AUST$SA1_MAINCODE_2016 <- as.character(SA1_2016_AUST$SA1_MAINCODE_2016)
#join
CG_SA1_2016_SA1_2021 <- left_join(CG_SA1_2016_SA1_2021, SA1_2016_AUST, by = "SA1_MAINCODE_2016")

#set names the same
names(Greater_Perth_SA1_UR_by_MTW15P_2016) <- 
  c("SA1_7DIGITCODE_2016", 
    names(Greater_Perth_SA1_UR_by_MTW15P_2016[,2:ncol(Greater_Perth_SA1_UR_by_MTW15P_2016)]))


#again set so types are the same
Greater_Perth_SA1_UR_by_MTW15P_2016$SA1_7DIGITCODE_2016 <- as.character(Greater_Perth_SA1_UR_by_MTW15P_2016$SA1_7DIGITCODE_2016)
CG_SA1_2016_SA1_2021$SA1_7DIGITCODE_2016 <- as.character(CG_SA1_2016_SA1_2021$SA1_7DIGITCODE_2016)




#Now join to the Journey to work data
Greater_Perth_SA1_UR_by_MTW15P_2016 <- left_join(Greater_Perth_SA1_UR_by_MTW15P_2016, CG_SA1_2016_SA1_2021, by = "SA1_7DIGITCODE_2016")

#multiply mode numbers by RATIO_FROM_TO value
Greater_Perth_SA1_UR_by_MTW15P_2016[,36:51] <- Greater_Perth_SA1_UR_by_MTW15P_2016[,2:17] * as.numeric(Greater_Perth_SA1_UR_by_MTW15P_2016$RATIO_FROM_TO)
#Drop unneeded columns
Greater_Perth_SA1_UR_by_MTW15P_2016 <- tibble(SA1_CODE_2021 = Greater_Perth_SA1_UR_by_MTW15P_2016$SA1_CODE_2021, Greater_Perth_SA1_UR_by_MTW15P_2016[,36:51])



```

Next, add the Heritage, North-south and Outer east groupings to the datasets. To do this, however, it is necessary to add the Local Government Areas (LGA) details to each dataset.  LGAs do not directly correspond to SA1 boundaries, so it will be necessary to 1. load the SA1 and DZ geometry to the journey to work datasets, 2. Load the LGA geometry, 3. Find the intersections of the LGA boundaries and the SA1s and the intersections of the LGA boundaries and the DZs.  

First, loading the ABS mapping data via the absmapsdata package [@absmapsdata] gives:

```{r load_absmapsdata_destination_zones_2021, echo=FALSE, fig.margin=TRUE, fig.cap="Perth 2021 destination zonea", cache=TRUE}

#Load DZ2021 data
DZ2021_map_data <- dz2021

#Load SA1_2021 data
sa1_2021_map_data <- sa12021

#Get the Greater Capital City names by sa2 
sa2_gcc_code <- tibble(sa2_code_2021 = sa1_2021_map_data$sa2_code_2021,
                       sa2_name_2021 = sa1_2021_map_data$sa2_name_2021,
                       gcc_name_2021 = sa1_2021_map_data$gcc_name_2021)
#and only keep unique records
sa2_gcc_code <- distinct(sa2_gcc_code)


#join gcc_name_2021 into DZ2021 dataset
DZ2021_map_data <- left_join(DZ2021_map_data, sa2_gcc_code, by = "sa2_code_2021")

#convert square km values back to numeric class
DZ2021_map_data$areasqkm_2021 <- as.numeric(DZ2021_map_data$areasqkm_2021) 

#Map destination zones
map <- DZ2021_map_data %>%
  filter(gcc_name_2021 == "Greater Perth") %>%   # let's just look at Perth
  ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = areasqkm_2021),     # fill by area size
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf()

map

#join destination zone geometry to destination zone JTW data
Greater_Perth_JTW_by_destination_2016 <- left_join(Greater_Perth_JTW_by_destination_2016, DZ2021_map_data, by = "dz_code_2021")
Greater_Perth_JTW_by_destination_2021 <- left_join(Greater_Perth_JTW_by_destination_2021, DZ2021_map_data, by = "dz_code_2021")
```

```{r load_absmapsdata_SA1_zones_2021, echo=FALSE, fig.margin=TRUE, fig.cap="Perth 2021 destination zonea", cache=TRUE}

#Map SA1 zones
map <- sa1_2021_map_data %>%
  filter(gcc_name_2021 == "Greater Perth") %>%   # let's just look at Perth
  ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = areasqkm_2021),     # fill by area size
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf()

map


#set names the same
names(Greater_Perth_SA1_UR_by_MTW15P_2016) <- 
  c("sa1_code_2021", 
    names(Greater_Perth_SA1_UR_by_MTW15P_2016[,2:ncol(Greater_Perth_SA1_UR_by_MTW15P_2016)]))
names(Greater_Perth_SA1_UR_by_MTW15P_2021) <- 
  c("sa1_code_2021", 
    names(Greater_Perth_SA1_UR_by_MTW15P_2021[,2:ncol(Greater_Perth_SA1_UR_by_MTW15P_2021)]))




#join destination zone geometry to destination zone JTW data
Greater_Perth_SA1_UR_by_MTW15P_2016 <- left_join(Greater_Perth_SA1_UR_by_MTW15P_2016, sa1_2021_map_data, by = "sa1_code_2021")
Greater_Perth_SA1_UR_by_MTW15P_2021 <- left_join(Greater_Perth_SA1_UR_by_MTW15P_2021, sa1_2021_map_data, by = "sa1_code_2021")
```

Next get the LGA boundaries, find intersections with JTW dataset geometries, and assign the goupings into the dataset..


```{r add_groupings, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.cap="Greater Perth: Heritage, North-south and Outer East groupings", cache=TRUE}

#get ABS LGA boundaries
lga_areas <- lga2021 %>% filter(state_name_2021 == "Western Australia")


#turn JTW datasets into sf objected
Greater_Perth_JTW_by_destination_2016 <- st_sf(Greater_Perth_JTW_by_destination_2016)
Greater_Perth_JTW_by_destination_2021 <- st_sf(Greater_Perth_JTW_by_destination_2021)
Greater_Perth_SA1_UR_by_MTW15P_2016 <- st_sf(Greater_Perth_SA1_UR_by_MTW15P_2016)
Greater_Perth_SA1_UR_by_MTW15P_2021 <- st_sf(Greater_Perth_SA1_UR_by_MTW15P_2021)




#find intersections of SA1 and LGA and DZ and LGA boundaries
Greater_Perth_SA1_UR_by_MTW15P_2016 <- st_intersection(Greater_Perth_SA1_UR_by_MTW15P_2016, lga_areas)
Greater_Perth_SA1_UR_by_MTW15P_2021 <- st_intersection(Greater_Perth_SA1_UR_by_MTW15P_2016, lga_areas)
Greater_Perth_JTW_by_destination_2016 <- st_intersection(Greater_Perth_JTW_by_destination_2016, lga_areas)
Greater_Perth_JTW_by_destination_2021 <- st_intersection(Greater_Perth_JTW_by_destination_2021, lga_areas)



LGA_to_group <- tibble(lga_name_2021 = 
c("Melville", "South Perth", "Stirling", "Joondalup", "Wanneroo", "Cockburn", "Kwinana", "Rockingham", "Murray", "Mandurah",
  "Bayswater", "Belmont", "Canning","Fremantle", "Nedlands", "Perth", "Subiaco", "Vincent", "Peppermint Grove", "Bassendean", "Cambridge", "Claremont", "Cottesloe", "East Fremantle", "Mosman Park", "Victoria Park","Gosnells",
  "Kalamunda", "Swan", "Mundaring", "Armadale", "Serpentine-Jarrahdale"),
grouping = c("North-south", "North-south","North-south","North-south","North-south","North-south","North-south","North-south","North-south","North-south", "Heritage", "Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage", "Outer east", "Outer east","Outer east","Outer east","Outer east")
)

#join grouping to JTW data frames
Greater_Perth_JTW_by_destination_2016 <- left_join(Greater_Perth_JTW_by_destination_2016, LGA_to_group, by = "lga_name_2021")
Greater_Perth_JTW_by_destination_2021 <- left_join(Greater_Perth_JTW_by_destination_2021, LGA_to_group, by = "lga_name_2021")
Greater_Perth_SA1_UR_by_MTW15P_2016 <- left_join(Greater_Perth_SA1_UR_by_MTW15P_2016, LGA_to_group, by = "lga_name_2021")
Greater_Perth_SA1_UR_by_MTW15P_2021 <- left_join(Greater_Perth_SA1_UR_by_MTW15P_2021, LGA_to_group, by = "lga_name_2021")


#fix names
names(Greater_Perth_JTW_by_destination_2016) <- c("dz_code_2021", "Train", "Bus", "Ferry", "Tram", "Taxi", "Car, as driver", "Car, as passenger", "Truck", "Motorbike", "Bicycle", "Walked only", "Other mode", "Worked at home", "Did not go to work", "Not stated", "Not applicable", "sa2_code_2021", "sa2_name_2021", "state_code_2021", "state_name_2021", "areasqkm_2021", "cent_lat", "cent_long", "sa2_name_2021.y", "sa2_name_2021.y", "gcc_name_2021", "lga_code_2021", "lga_name_2021", "state_code_2021.1", "state_name_2021.1", "areasqkm_2021.1", "cent_lat.1", "cent_long.1", "geometry", "grouping")

names(Greater_Perth_JTW_by_destination_2021) <- c("dz_code_2021", "Train", "Bus", "Ferry", "Tram", "Taxi", "Car, as driver", "Car, as passenger", "Truck", "Motorbike", "Bicycle", "Walked only", "Other mode", "Worked at home", "Did not go to work", "Not stated", "Not applicable", "sa2_code_2021", "sa2_name_2021", "state_code_2021", "state_name_2021", "areasqkm_2021", "cent_lat", "cent_long", "sa2_name_2021.y", "sa2_name_2021.y", "gcc_name_2021", "lga_code_2021", "lga_name_2021", "state_code_2021.1", "state_name_2021.1", "areasqkm_2021.1", "cent_lat.1", "cent_long.1", "geometry", "grouping")

names(Greater_Perth_SA1_UR_by_MTW15P_2016) <- c("sa1_code_2021", "Train", "Bus", "Ferry", "Tram", "Taxi", "Car, as driver", "Car, as passenger", "Truck", "Motorbike", "Bicycle", "Walked only", "Other mode", "Worked at home", "Did not go to work", "Not stated", "Not applicable", "sa2_code_2021", "sa2_name_2021", "sa3_code_2021", "sa3_name_2021", "sa4_code_2021", "sa4_name_2021", "gcc_code_2021", "gcc_name_2021", "state_code_2021", "state_name_2021", "areasqkm_2021", "cent_lat", "cent_long", "lga_code_2021", "lga_name_2021", "state_code_2021.1", "state_name_2021.1", "areasqkm_2021.1", "cent_lat.1", "cent_long.1", "geometry", "grouping")
names(Greater_Perth_SA1_UR_by_MTW15P_2021) <- c("sa1_code_2021", "Train", "Bus", "Ferry", "Tram", "Taxi", "Car, as driver", "Car, as passenger", "Truck", "Motorbike", "Bicycle", "Walked only", "Other mode", "Worked at home", "Did not go to work", "Not stated", "Not applicable", "sa2_code_2021", "sa2_name_2021", "sa3_code_2021", "sa3_name_2021", "sa4_code_2021", "sa4_name_2021", "gcc_code_2021", "gcc_name_2021", "state_code_2021", "state_name_2021", "areasqkm_2021", "cent_lat", "cent_long", "lga_code_2021", "lga_name_2021", "state_code_2021.1", "state_name_2021.1", "areasqkm_2021.1", "cent_lat.1", "cent_long.1", "lga_code_2021.1", "lga_name_2021.1", "state_code_2021.2", "state_name_2021.2", "areasqkm_2021.2", "cent_lat.2", "cent_long.2", "geometry", "grouping")


#Map Groupings
map <- Greater_Perth_SA1_UR_by_MTW15P_2016 %>%
    ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = grouping),     # fill by grouping
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf() 

map 


                      
```



# 3.0 Results

## 3.1 Aggregate for Greater Perth
```{r Greater_Perth_JTW_aggregate, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE, fig.cap="Greater Perth, journey to work mode share, 2021 and 2016 censuses"}

Greater_Perth_JTW_by_destination_2016_no_geometry <- Greater_Perth_JTW_by_destination_2016 %>% st_drop_geometry()
Greater_Perth_JTW_by_destination_2021_no_geometry <- Greater_Perth_JTW_by_destination_2021 %>% st_drop_geometry()
Greater_Perth_SA1_UR_by_MTW15P_2016_no_geometry <- Greater_Perth_SA1_UR_by_MTW15P_2016 %>% st_drop_geometry()
Greater_Perth_SA1_UR_by_MTW15P_2021_no_geometry <- Greater_Perth_SA1_UR_by_MTW15P_2021 %>% st_drop_geometry()

#calculate aggregates for everyone with a usual residence in perth
Aggregate_JTW_2016_2021 <- tibble(Greater_Perth_SA1_UR_by_MTW15P_2016_no_geometry[,1:17] %>% adorn_totals() %>% tail(n=1))
Aggregate_JTW_2016_2021 <- add_row(Aggregate_JTW_2016_2021, Greater_Perth_SA1_UR_by_MTW15P_2021_no_geometry[,1:17] %>% adorn_totals() %>% tail(n=1))

Aggregate_JTW_2016_2021$Year <- c("2016", "2021")

#combine modes to obtain PT, private vehicle (drive), private vehicle (passenger)  and non-motorised columns
Aggregate_JTW_2016_2021$`Private vehicle (drive)` <- Aggregate_JTW_2016_2021$`Car, as driver` + Aggregate_JTW_2016_2021$Truck + Aggregate_JTW_2016_2021$Motorbike  

Aggregate_JTW_2016_2021$`Private vehicle (passenger)` <- Aggregate_JTW_2016_2021$`Car, as passenger` + Aggregate_JTW_2016_2021$Taxi  

Aggregate_JTW_2016_2021$Transit <- Aggregate_JTW_2016_2021$Train + Aggregate_JTW_2016_2021$Bus + Aggregate_JTW_2016_2021$Ferry + Aggregate_JTW_2016_2021$Tram

Aggregate_JTW_2016_2021$`Non-motorised` <- Aggregate_JTW_2016_2021$Bicycle + Aggregate_JTW_2016_2021$`Walked only`

#Round all to whole number of people (as correspondence to convert 2016 to 2021 SA1s resulted in some fractional people)
Aggregate_JTW_2016_2021 <-Aggregate_JTW_2016_2021 %>% mutate_if(is.numeric, round, digits = 0)

#pivot_longer 
Aggregate_JTW_2016_2021_summary_longer <- pivot_longer(
  Aggregate_JTW_2016_2021[, c("Year", "Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other mode", "Worked at home")], 
  cols = c("Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other mode", "Worked at home"), 
  names_to = "Mode or activity",
  values_to = "People"
)

#Round to whole number of people (as the correspondence to convert 2016 to 2021 SA1s resulted in some fractional people)
#Aggregate_JTW_2016_2021_summary_longer$People <- round(Aggregate_JTW_2016_2021_summary_longer$People, digits = 0)

#turn mode into a factor to get a specific order
Aggregate_JTW_2016_2021_summary_longer$`Mode or activity` <- factor( Aggregate_JTW_2016_2021_summary_longer$`Mode or activity`, levels = c("Worked at home", "Other mode", "Non-motorised", "Transit", "Private vehicle (passenger)", "Private vehicle (drive)"))

p <- ggbarstats(
  Aggregate_JTW_2016_2021_summary_longer[,], 
  x = `Mode or activity`,
  y = Year,
  counts = People
)

p

kable(untabyl(Aggregate_JTW_2016_2021[, c("Year", "Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other mode", "Worked at home")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares, persons with a usual residence in Greater Perth, 2016 and 2021 censuses"
)

```
The changes in mode/activity share are small, but statistically significant 
```{r extract_stats1 , echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE, fig.cap="Greater Perth, journey to work mode share, 2021 and 2016 censuses, transit modes"}
extract_caption(p)

```


```{r Greater_Perth_JTW_aggregate_transit, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE, fig.cap="Greater Perth, journey to work mode share, 2021 and 2016 censuses, transit modes"}

#pivot_longer 
Aggregate_JTW_2016_2021_transit_longer <- pivot_longer(
  Aggregate_JTW_2016_2021[, c("Year", "Train", "Bus")], 
  cols = c("Train", "Bus"), 
  names_to = "Mode",
  values_to = "People"
)

#Round to whole number of people (as the correspondence to convert 2016 to 2021 SA1s resulted in some fractional people)
#Aggregate_JTW_2016_2021_summary_longer$People <- round(Aggregate_JTW_2016_2021_summary_longer$People, digits = 0)

#turn mode into a factor to get a specific order
Aggregate_JTW_2016_2021_transit_longer$`Mode` <- factor( Aggregate_JTW_2016_2021_transit_longer$`Mode`, levels = c("Bus", "Train"))

p <- ggbarstats(
  Aggregate_JTW_2016_2021_transit_longer[,], 
  x = `Mode`,
  y = Year,
  counts = People
)

p

kable(untabyl(Aggregate_JTW_2016_2021[, c("Year", "Train", "Bus")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares, persons with a usual residence in Greater Perth, 2016 and 2021 censuses, transit modes"
)

```

The changes in mode/activity share are small, but statistically significant 
```{r extract_stats2 , echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE, fig.cap="Greater Perth, journey to work mode share, 2021 and 2016 censuses, transit modes"}
extract_caption(p)

```


## 3.2 Disaggregate (Heritage, N-S, Outer east)

```{r Greater_Perth_JTW_disaggregate, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE, fig.cap="Greater Perth, journey to work mode share, 2021 and 2016 censuses"}

Greater_Perth_SA1_UR_by_MTW15P_2016_no_geometry_disaggregate <- split (Greater_Perth_SA1_UR_by_MTW15P_2016_no_geometry,Greater_Perth_SA1_UR_by_MTW15P_2016_no_geometry$grouping)

Greater_Perth_SA1_UR_by_MTW15P_2021_no_geometry_disaggregate <- split (Greater_Perth_SA1_UR_by_MTW15P_2021_no_geometry, Greater_Perth_SA1_UR_by_MTW15P_2021_no_geometry$grouping)



##calculate for everyone with a usual residence in perth, by grouping
#2016
Group_JTW_2016 <- lapply(
  Greater_Perth_SA1_UR_by_MTW15P_2016_no_geometry_disaggregate,  
  function(x) x%>% 
    dplyr::select(sa1_code_2021, Train, Bus, Ferry, Tram, Taxi, "Car, as driver", "Car, as passenger", "Truck", "Motorbike", "Bicycle", "Walked only", "Other mode", "Worked at home", "Not stated", "Not applicable")
)
Group_JTW_2016 <- Group_JTW_2016  %>% 
                    adorn_totals() 
Group_JTW_2016 <- lapply(
  Group_JTW_2016,  
  function(x) x%>% 
    tail(n=1)
)
#Add year as 2016
f <- function (data, name){
  data$Year <- "2016"
  data
}
Group_JTW_2021 <- Map(f, Group_JTW_2021, names(Group_JTW_2021)) 


#2021
Group_JTW_2021 <- lapply(
  Greater_Perth_SA1_UR_by_MTW15P_2021_no_geometry_disaggregate,  
  function(x) x%>% 
    dplyr::select(sa1_code_2021, Train, Bus, Ferry, Tram, Taxi, "Car, as driver", "Car, as passenger", "Truck", "Motorbike", "Bicycle", "Walked only", "Other mode", "Worked at home", "Not stated", "Not applicable")
)
Group_JTW_2021 <- Group_JTW_2021  %>% 
                    adorn_totals() 
Group_JTW_2021 <- lapply(
  Group_JTW_2021,  
  function(x) x%>% 
    tail(n=1)
)

#Add year as 2021
f <- function (data, name){
  data$Year <- "2020"
  data
}

#NEXT combine into one 2016+2021 dataframe

#combine modes to obtain PT, private vehicle (drive), private vehicle (passenger)  and non-motorised columns
Aggregate_JTW_2016_2021$`Private vehicle (drive)` <- Aggregate_JTW_2016_2021$`Car, as driver` + Aggregate_JTW_2016_2021$Truck + Aggregate_JTW_2016_2021$Motorbike  

Aggregate_JTW_2016_2021$`Private vehicle (passenger)` <- Aggregate_JTW_2016_2021$`Car, as passenger` + Aggregate_JTW_2016_2021$Taxi  

Aggregate_JTW_2016_2021$Transit <- Aggregate_JTW_2016_2021$Train + Aggregate_JTW_2016_2021$Bus + Aggregate_JTW_2016_2021$Ferry + Aggregate_JTW_2016_2021$Tram

Aggregate_JTW_2016_2021$`Non-motorised` <- Aggregate_JTW_2016_2021$Bicycle + Aggregate_JTW_2016_2021$`Walked only`

#Round all to whole number of people (as correspondence to convert 2016 to 2021 SA1s resulted in some fractional people)
Aggregate_JTW_2016_2021 <-Aggregate_JTW_2016_2021 %>% mutate_if(is.numeric, round, digits = 0)

#pivot_longer 
Aggregate_JTW_2016_2021_summary_longer <- pivot_longer(
  Aggregate_JTW_2016_2021[, c("Year", "Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other mode", "Worked at home")], 
  cols = c("Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other mode", "Worked at home"), 
  names_to = "Mode or activity",
  values_to = "People"
)

#Round to whole number of people (as the correspondence to convert 2016 to 2021 SA1s resulted in some fractional people)
#Aggregate_JTW_2016_2021_summary_longer$People <- round(Aggregate_JTW_2016_2021_summary_longer$People, digits = 0)

#turn mode into a factor to get a specific order
Aggregate_JTW_2016_2021_summary_longer$`Mode or activity` <- factor( Aggregate_JTW_2016_2021_summary_longer$`Mode or activity`, levels = c("Worked at home", "Other mode", "Non-motorised", "Transit", "Private vehicle (passenger)", "Private vehicle (drive)"))

p <- ggbarstats(
  Aggregate_JTW_2016_2021_summary_longer[,], 
  x = `Mode or activity`,
  y = Year,
  counts = People
)

p

kable(untabyl(Aggregate_JTW_2016_2021[, c("Year", "Private vehicle (drive)", "Private vehicle (passenger)", "Transit", "Non-motorised", "Other mode", "Worked at home")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares, persons with a usual residence in Greater Perth, 2016 and 2021 censuses"
)

```
The changes in mode/activity share are small, but statistically significant 
```{r extract_stats1 , echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE, fig.cap="Greater Perth, journey to work mode share, 2021 and 2016 censuses, transit modes"}
extract_caption(p)

```


```{r Greater_Perth_JTW_aggregate_transit, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE, fig.cap="Greater Perth, journey to work mode share, 2021 and 2016 censuses, transit modes"}

#pivot_longer 
Aggregate_JTW_2016_2021_transit_longer <- pivot_longer(
  Aggregate_JTW_2016_2021[, c("Year", "Train", "Bus")], 
  cols = c("Train", "Bus"), 
  names_to = "Mode",
  values_to = "People"
)

#Round to whole number of people (as the correspondence to convert 2016 to 2021 SA1s resulted in some fractional people)
#Aggregate_JTW_2016_2021_summary_longer$People <- round(Aggregate_JTW_2016_2021_summary_longer$People, digits = 0)

#turn mode into a factor to get a specific order
Aggregate_JTW_2016_2021_transit_longer$`Mode` <- factor( Aggregate_JTW_2016_2021_transit_longer$`Mode`, levels = c("Bus", "Train"))

p <- ggbarstats(
  Aggregate_JTW_2016_2021_transit_longer[,], 
  x = `Mode`,
  y = Year,
  counts = People
)

p

kable(untabyl(Aggregate_JTW_2016_2021[, c("Year", "Train", "Bus")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares, persons with a usual residence in Greater Perth, 2016 and 2021 censuses, transit modes"
)

```

The changes in mode/activity share are small, but statistically significant 
```{r extract_stats2 , echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE, fig.cap="Greater Perth, journey to work mode share, 2021 and 2016 censuses, transit modes"}
extract_caption(p)

```

```


## 3.3 CBD vs non-CBD

## 3.3.1 Aggregate for Greater Perth

## 3.3.2 Disaggregate (Heritage, N-S, Outer east)



-->

# 4.0 Discussion

# 5.0 Conclusions

#References



```{r bib, include=FALSE}
# create a bib file for the R packages used in this document
knitr::write_bib(c('base', 'rmarkdown'), file = 'skeleton.bib')
```
