---
title: "Perth COVID-19 study; journey to work census analysis"
runningheader: "Perth COVID-19 study; journey to work census analysis" # only for pdf output
subtitle: "Perth COVID-19 study; journey to work census analysis" # only for html output
author: "Dr James Reynolds, Monash University Public Transport Research Group (PTRG)"
date: "`r Sys.Date()`"
output:
  tufte::tufte_html: default
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
bibliography: Perth_JTW_census_analysis.bib
link-citations: yes
---

```{r setup, include=FALSE}
library(tufte)
library(tidyverse)
library(sp)
library(ggplot2)
library(sf)
library(ASGS.foyer)
library(raster)
library(ggmap)
library(units)
library(absmapsdata)
library(readabs)
library(readr)
library(janitor)
library(scales)
library(ggstatsplot)
library(ggmap)

# invalidate cache when the tufte version changes
knitr::opts_chunk$set(cache.extra = packageVersion('tufte'))
options(htmltools.dir.version = FALSE)
```

# 1.0 Introduction
The Monash University Public Transport Research Group is looking at changes in travel behaviour in Perth surrounding the COVID-19 pandemic. Part of this work involves examining the Australian Bureau of Statistics (ABS) journey-to-work data for the 2016 and 2021 censuses. This working note details the process of collecting and reviewing the ABS data. It is structured as follows: the next section details the processing of the ABS data; Section 3 presents the results; followed by a brief discussion in Section 4; and conclusions in Section 5. 

# 2.0 Methods and data processing
The census asks respondents about their journey-to-work mode choice and destination. Destinations are allocated to Destination Zones, which can be obtained using the ABS data manipulation package absmapsdata [@absmapsdata]^[See https://github.com/wfmackey/absmapsdata]. 


```{r load_abs_data, echo=FALSE, message = FALSE, fig.margin=TRUE, fig.cap="Perth 2016 destination zonea", cache=TRUE}

#Load DZ2016 data
DZ2016_map_data <- dz2016

#Load SA1_2016 data
sa1_2016_map_data <- sa12016

#Get the Greater Capital City names by sa2 
sa2_gcc_code <- tibble(sa2_code_2016 = sa1_2016_map_data$sa2_code_2016,
                       sa2_name_2016 = sa1_2016_map_data$sa2_name_2016,
                       gcc_name_2016 = sa1_2016_map_data$gcc_name_2016)
#and only keep unique records
sa2_gcc_code <- distinct(sa2_gcc_code)



#join gcc_name_2016 into DZ2016 dataset
DZ2016_map_data_joined_gcc <- left_join(DZ2016_map_data, sa2_gcc_code, by = "sa2_code_2016")


#convert square km values back to numeric class
DZ2016_map_data_joined_gcc$areasqkm_2016 <- as.numeric(DZ2016_map_data_joined_gcc$areasqkm_2016) 

#Map destination zones
map <- DZ2016_map_data_joined_gcc %>%
  filter(gcc_name_2016 == "Greater Perth") %>%   # let's just look at Perth
  ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = areasqkm_2016),     # fill by area size
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf()

#map

```


```{r load_abs_2021_destination_zones_data, echo=FALSE, fig.margin=TRUE, fig.cap="Perth 2021 destination zonea", cache=TRUE}

#Load DZ2021 data
DZ2021_map_data <- dz2021

#Load SA1_2021 data
sa1_2021_map_data <- sa12021

#Get the Greater Capital City names by sa2 
sa2_gcc_code <- tibble(sa2_code_2021 = sa1_2021_map_data$sa2_code_2021,
                       sa2_name_2021 = sa1_2021_map_data$sa2_name_2021,
                       gcc_name_2021 = sa1_2021_map_data$gcc_name_2021)
#and only keep unique records
sa2_gcc_code <- distinct(sa2_gcc_code)


#join gcc_name_2021 into DZ2021 dataset
DZ2021_map_data_joined_gcc <- left_join(DZ2021_map_data, sa2_gcc_code, by = "sa2_code_2021")

#convert square km values back to numeric class
DZ2021_map_data_joined_gcc$areasqkm_2021 <- as.numeric(DZ2021_map_data_joined_gcc$areasqkm_2021) 



#Map destination zones
map <- DZ2021_map_data_joined_gcc %>%
  filter(gcc_name_2021 == "Greater Perth") %>%   # let's just look at Perth
  ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = areasqkm_2021),     # fill by area size
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf()

#map

```


The Journey-To-Work (JTW) data was extracted using the Table Builder on the ABS website. Data from 2016 and 2021 for Greater Perth was obtained. Join this with the Destination Zones allows mode shares to be mapped, as shown in the margin figure.

```{r load_abs_jtw_data, echo=FALSE, message = FALSE, warning=FALSE, fig.margin=TRUE, fig.cap="Greater Perth, car driver mode share by destination zone, 2016", cache=TRUE}

Greater_Perth_JTW_by_destination_2016 <- read_csv("01 data/Greater_Perth_JTW_by_destination_2016.csv", 
    skip = 8)
Greater_Perth_JTW_by_destination_2021 <- read_csv("01 data/Greater_Perth_JTW_by_destination_2021.csv", 
    skip = 8)
Greater_Perth_JTW_by_origin_2016 <- read_csv("01 data/Greater_Perth_JTW_by_origin_2016.csv", 
    skip = 8)
Greater_Perth_JTW_by_origin_2021 <- read_csv("01 data/Greater_Perth_JTW_by_origin_2021.csv", 
    skip = 8)



#remove first empty row and last 5 rows with copywrite info
Greater_Perth_JTW_by_destination_2016 <- Greater_Perth_JTW_by_destination_2016[2:(nrow(Greater_Perth_JTW_by_destination_2016)-5),]
Greater_Perth_JTW_by_destination_2021<- Greater_Perth_JTW_by_destination_2021[2:(nrow(Greater_Perth_JTW_by_destination_2021)-5),]
Greater_Perth_JTW_by_origin_2016 <- Greater_Perth_JTW_by_origin_2016[2:(nrow(Greater_Perth_JTW_by_origin_2016)-5),]
Greater_Perth_JTW_by_origin_2021 <- Greater_Perth_JTW_by_origin_2021[2:(nrow(Greater_Perth_JTW_by_origin_2021)-5),]

#Train column as numeric
Greater_Perth_JTW_by_destination_2016$Train <- as.numeric(Greater_Perth_JTW_by_destination_2016$Train)
Greater_Perth_JTW_by_destination_2021$Train <- as.numeric(Greater_Perth_JTW_by_destination_2021$Train)


#update first column name to be dz_code_2016
names(Greater_Perth_JTW_by_destination_2016) <- 
  c("dz_code_2016", 
    names(Greater_Perth_JTW_by_destination_2016[,2:ncol(Greater_Perth_JTW_by_destination_2016)]))
#Do same update first column name to be dz_code_2021
names(Greater_Perth_JTW_by_destination_2021) <- 
  c("dz_code_2021", 
    names(Greater_Perth_JTW_by_destination_2021[,2:ncol(Greater_Perth_JTW_by_destination_2021)]))



#drop total column and convert to percentages
Greater_Perth_JTW_by_destination_2016 <- tibble(Greater_Perth_JTW_by_destination_2016[,1:17] %>% adorn_percentages()) 
Greater_Perth_JTW_by_destination_2021 <- tibble(Greater_Perth_JTW_by_destination_2021[,1:17] %>% adorn_percentages())

# and join
Greater_Perth_JTW_by_DZ2016_2016 <- right_join(DZ2016_map_data_joined_gcc, Greater_Perth_JTW_by_destination_2016, by = "dz_code_2016")
# and join
Greater_Perth_JTW_by_DZ2021_2021 <- right_join(DZ2021_map_data_joined_gcc, Greater_Perth_JTW_by_destination_2021, by = "dz_code_2021")


#Map destination zones
map <- Greater_Perth_JTW_by_DZ2016_2016 %>%
  filter(gcc_name_2016 == "Greater Perth") %>%   # let's just look at Perth
  ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = `Car, as driver`),     # fill by car driver mode share
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf() +
  scale_fill_continuous(labels=scales::percent)


map


```



```{r shift_into_one_data_frame_and_calculate_differences, echo=FALSE, message= FALSE, warning=FALSE, fig.margin=TRUE, fig.cap="Greater Perth, car driver mode share by destination zone, 2016", cache=TRUE}

#move 2016 data into combined dataframe
Greater_Perth_JTW_by_DZ <- Greater_Perth_JTW_by_DZ2016_2016
#strip 2016 from column names and match to 2021 column names
names(Greater_Perth_JTW_by_DZ) <- c("dz_code", "sa2_code", "sa2_shortcode", "sa2_name.x", "state_code", "state_name",
"areasqkm", "cent_lat", "cent_long", "sa2_name.y",  "gcc_name", "Train", "Bus", "Ferry", "Tram/light rail", "Taxi/ride-share service", "Car, as driver", "Car, as passenger", "Truck", "Motorbike/scooter", "Bicycle", "Walked only", "Other mode","Worked at home", "Did not got to work", "Not stated", "Not applicable", "geometry")

#add census year identifier
Greater_Perth_JTW_by_DZ$census <- "2016"

#add 2021 as rows to the combined dataframe
Greater_Perth_JTW_by_DZ <- Greater_Perth_JTW_by_DZ %>% add_row(
  dz_code = Greater_Perth_JTW_by_DZ2021_2021$dz_code_2021, 
  sa2_code = Greater_Perth_JTW_by_DZ2021_2021$sa2_code_2021, 
  sa2_shortcode = NA, 
  sa2_name.x = Greater_Perth_JTW_by_DZ2021_2021$sa2_name_2021.x, 
  state_code = Greater_Perth_JTW_by_DZ2021_2021$state_code_2021, 
  state_name = Greater_Perth_JTW_by_DZ2021_2021$state_name_2021, 
  areasqkm = Greater_Perth_JTW_by_DZ2021_2021$areasqkm_2021,
  cent_lat = Greater_Perth_JTW_by_DZ2021_2021$cent_lat,
  cent_long = Greater_Perth_JTW_by_DZ2021_2021$cent_long,
  sa2_name.y = Greater_Perth_JTW_by_DZ2021_2021$sa2_name_2021.y,
  gcc_name = Greater_Perth_JTW_by_DZ2021_2021$gcc_name_2021,
  Train = Greater_Perth_JTW_by_DZ2021_2021$Train,
  Bus = Greater_Perth_JTW_by_DZ2021_2021$Bus,
  Ferry = Greater_Perth_JTW_by_DZ2021_2021$Ferry,
  `Tram/light rail` = Greater_Perth_JTW_by_DZ2021_2021$`Tram/light rail`,
  `Taxi/ride-share service` = Greater_Perth_JTW_by_DZ2021_2021$`Taxi/ride-share service`,
  `Car, as driver` = Greater_Perth_JTW_by_DZ2021_2021$`Car, as driver`,
  `Car, as passenger` = Greater_Perth_JTW_by_DZ2021_2021$`Car, as passenger`,
  Truck = Greater_Perth_JTW_by_DZ2021_2021$Truck,
  `Motorbike/scooter` = Greater_Perth_JTW_by_DZ2021_2021$`Motorbike/scooter`,
  Bicycle = Greater_Perth_JTW_by_DZ2021_2021$Bicycle,
  `Walked only` = Greater_Perth_JTW_by_DZ2021_2021$`Walked only`,
  `Other mode` = Greater_Perth_JTW_by_DZ2021_2021$`Other Mode`,
  `Worked at home` = Greater_Perth_JTW_by_DZ2021_2021$`Worked at home`,
  `Did not got to work` = Greater_Perth_JTW_by_DZ2021_2021$`Did not go to work`,
  `Not stated` = Greater_Perth_JTW_by_DZ2021_2021$`Not stated`,
  `Not applicable` = Greater_Perth_JTW_by_DZ2021_2021$`Not applicable`,
  geometry = Greater_Perth_JTW_by_DZ2021_2021$geometry,
  census = "2021")
                
##create a dataframe that has the difference between the 2021 and 2016 mode shares, by 2021 DZ code
#first insert 2016 data
Greater_Perth_JTW_by_destination_2021_minus_2016 <-Greater_Perth_JTW_by_destination_2016
#change column names to distinguish between 2021 and 2016, and to match 2021 Dz codes to 2016 Dz codes
names(Greater_Perth_JTW_by_destination_2021_minus_2016) <- c(
  "dz_code_2021", 
  "Train_2016", 
  "Bus_2016", 
  "Ferry_2016", 
  "Tram/light rail_2016", 
  "Taxi/ride-share service_2016", 
  "Car, as driver_2016", 
  "Car, as passenger_2016", 
  "Truck_2016", 
  "Motorbike/scooter_2016", 
  "Bicycle_2016", 
  "Walked only_2016", 
  "Other mode_2016",
  "Worked at home_2016", 
  "Did not got to work_2016", 
  "Not stated_2016", 
  "Not applicable_2016")
#join based on Dz code
Greater_Perth_JTW_by_destination_2021_minus_2016 <- left_join(Greater_Perth_JTW_by_destination_2021_minus_2016, Greater_Perth_JTW_by_destination_2021)
#subtract 2016 from 2021
Greater_Perth_JTW_by_destination_2021_minus_2016$Train <- Greater_Perth_JTW_by_destination_2021_minus_2016$Train - Greater_Perth_JTW_by_destination_2021_minus_2016$Train_2016
Greater_Perth_JTW_by_destination_2021_minus_2016$Bus <- Greater_Perth_JTW_by_destination_2021_minus_2016$Bus - Greater_Perth_JTW_by_destination_2021_minus_2016$Bus_2016
Greater_Perth_JTW_by_destination_2021_minus_2016$Ferry <- Greater_Perth_JTW_by_destination_2021_minus_2016$Ferry - Greater_Perth_JTW_by_destination_2021_minus_2016$Ferry_2016
Greater_Perth_JTW_by_destination_2021_minus_2016$`Tram/light rail` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Tram/light rail` - Greater_Perth_JTW_by_destination_2021_minus_2016$`Tram/light rail_2016`
Greater_Perth_JTW_by_destination_2021_minus_2016$`Taxi/ride-share service` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Taxi/ride-share service` -  Greater_Perth_JTW_by_destination_2021_minus_2016$`Taxi/ride-share service_2016`
Greater_Perth_JTW_by_destination_2021_minus_2016$`Car, as driver` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Car, as driver` - Greater_Perth_JTW_by_destination_2021_minus_2016$`Car, as driver_2016`
Greater_Perth_JTW_by_destination_2021_minus_2016$`Car, as passenger` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Car, as passenger`- Greater_Perth_JTW_by_destination_2021_minus_2016$`Car, as passenger_2016`
Greater_Perth_JTW_by_destination_2021_minus_2016$Truck <- Greater_Perth_JTW_by_destination_2021_minus_2016$Truck- Greater_Perth_JTW_by_destination_2021_minus_2016$Truck_2016
Greater_Perth_JTW_by_destination_2021_minus_2016$`Motorbike/scooter` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Motorbike/scooter`- Greater_Perth_JTW_by_destination_2021_minus_2016$`Motorbike/scooter_2016`
Greater_Perth_JTW_by_destination_2021_minus_2016$Bicycle <- Greater_Perth_JTW_by_destination_2021_minus_2016$Bicycle- Greater_Perth_JTW_by_destination_2021_minus_2016$Bicycle_2016
Greater_Perth_JTW_by_destination_2021_minus_2016$`Other Mode` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Other Mode`- Greater_Perth_JTW_by_destination_2021_minus_2016$`Other mode_2016`
Greater_Perth_JTW_by_destination_2021_minus_2016$`Walked only` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Walked only`- Greater_Perth_JTW_by_destination_2021_minus_2016$`Walked only_2016`
Greater_Perth_JTW_by_destination_2021_minus_2016$`Worked at home` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Worked at home`- Greater_Perth_JTW_by_destination_2021_minus_2016$`Worked at home_2016`
Greater_Perth_JTW_by_destination_2021_minus_2016$`Did not go to work` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Did not go to work`- Greater_Perth_JTW_by_destination_2021_minus_2016$`Did not got to work_2016`
Greater_Perth_JTW_by_destination_2021_minus_2016$`Not stated` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Not stated`- Greater_Perth_JTW_by_destination_2021_minus_2016$`Not stated_2016`
Greater_Perth_JTW_by_destination_2021_minus_2016$`Not applicable` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Not applicable`- Greater_Perth_JTW_by_destination_2021_minus_2016$`Not applicable_2016`

#join difference between 2021 and 2016 to DZ geometry
Greater_Perth_JTW_by_destination_2021_minus_2016 <- right_join(DZ2021_map_data_joined_gcc, Greater_Perth_JTW_by_destination_2021_minus_2016, by = "dz_code_2021")


#add difference between 2021 and 2016 as rows to the combined dataframe
Greater_Perth_JTW_by_DZ <- Greater_Perth_JTW_by_DZ %>% add_row(
  dz_code = Greater_Perth_JTW_by_destination_2021_minus_2016$dz_code_2021, 
  sa2_code = Greater_Perth_JTW_by_destination_2021_minus_2016$sa2_code_2021, 
  sa2_shortcode = NA, 
  sa2_name.x = Greater_Perth_JTW_by_destination_2021_minus_2016$sa2_name_2021.x, 
  state_code = Greater_Perth_JTW_by_destination_2021_minus_2016$state_code_2021, 
  state_name = Greater_Perth_JTW_by_destination_2021_minus_2016$state_name_2021, 
  areasqkm = Greater_Perth_JTW_by_destination_2021_minus_2016$areasqkm_2021,
  cent_lat = Greater_Perth_JTW_by_destination_2021_minus_2016$cent_lat,
  cent_long = Greater_Perth_JTW_by_destination_2021_minus_2016$cent_long,
  sa2_name.y = Greater_Perth_JTW_by_destination_2021_minus_2016$sa2_name_2021.y,
  gcc_name = Greater_Perth_JTW_by_destination_2021_minus_2016$gcc_name_2021,
  Train = Greater_Perth_JTW_by_destination_2021_minus_2016$Train,
  Bus = Greater_Perth_JTW_by_destination_2021_minus_2016$Bus,
  Ferry = Greater_Perth_JTW_by_destination_2021_minus_2016$Ferry,
  `Tram/light rail` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Tram/light rail`,
  `Taxi/ride-share service` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Taxi/ride-share service`,
  `Car, as driver` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Car, as driver`,
  `Car, as passenger` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Car, as passenger`,
  Truck = Greater_Perth_JTW_by_destination_2021_minus_2016$Truck,
  `Motorbike/scooter` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Motorbike/scooter`,
  Bicycle = Greater_Perth_JTW_by_destination_2021_minus_2016$Bicycle,
  `Walked only` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Walked only`,
  `Other mode` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Other Mode`,
  `Worked at home` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Worked at home`,
  `Did not got to work` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Did not go to work`,
  `Not stated` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Not stated`,
  `Not applicable` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Not applicable`,
  geometry = Greater_Perth_JTW_by_destination_2021_minus_2016$geometry,
  census = "Change: 2021 to 2016")
 


```

Next, the Greater Perth area is divided into the analysis areas defined in Graham's sample size jottings worksheet. These are the North-South Group ^[City of Melville, City of South Perth, City of Stirling, City of Joondalup, City of Wanneroo, City of Cockburn, City of Kwinana, City of Rockingham, City of Murray and City of Mandurah.], the Heritage Group ^[City of Bayswater, City of Belmont, City of Canning, City of Fremantle, City of Nedlands, City of Perth, City of Subiaco, City of Vincent, Shire of Peppermint Grove, Town of Bassendean, Town of Cambridge, Town of Claremont, Town of Cottesloe, Town of East Fremantle, Town of Mosman Park, Town of Victoria Park and City of Gosnells.] and the Outer East^[City of Kalamunda, City of Swan, Shire of Mundaring, City of Armadale, and Shire of Serpentine-Jarrahdale.].



```{r add_groupings, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.cap="Greater Perth: Heritage, North-south and Outer East groupings", cache=TRUE}

#get ABS LGA boundaries
lga_areas <- lga2021 %>% filter(state_name_2021 == "Western Australia")

#find intersections of Destination zones and LGA boundaries
Greater_Perth_JTW_by_DZ <- st_intersection(Greater_Perth_JTW_by_DZ, lga_areas)

LGA_to_group <- tibble(lga_name_2021 = 
c("Melville", "South Perth", "Stirling", "Joondalup", "Wanneroo", "Cockburn", "Kwinana", "Rockingham", "Murray", "Mandurah",
  "Bayswater", "Belmont", "Canning","Fremantle", "Nedlands", "Perth", "Subiaco", "Vincent", "Peppermint Grove", "Bassendean", "Cambridge", "Claremont", "Cottesloe", "East Fremantle", "Mosman Park", "Victoria Park","Gosnells",
  "Kalamunda", "Swan", "Mundaring", "Armadale", "Serpentine-Jarrahdale"),
grouping = c("North-south", "North-south","North-south","North-south","North-south","North-south","North-south","North-south","North-south","North-south", "Heritage", "Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage", "Outer east", "Outer east","Outer east","Outer east","Outer east")
)

#join grouping to DZ
Greater_Perth_JTW_by_DZ <- left_join(Greater_Perth_JTW_by_DZ, LGA_to_group, by = "lga_name_2021")
   

#Map Groupings
map <- Greater_Perth_JTW_by_DZ %>%
    ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = grouping),     # fill by grouping
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf() 

map 
#+ qmap(location = "Perth")

#Somewhere along the way the column names where changed to have . rather than spaces, let's change that back

names(Greater_Perth_JTW_by_DZ) <- c("dz_code", "sa2_code", "sa2_shortcode", "sa2_name.x", "state_code", "state_name", "areadsqkm", "cent_lat", "cent_long", "sa2_name.y", "gcc_name", "Train", "Bus", "Ferry", "Tram or light rail", "Taxi or ride share service", "Car, as driver", "Car, as passenger", "Truck", "Motorbike or scooter", "Bicycle", "Walked only", "Other mode", "Worked at home", "Did not go to work", "Not stated", "Not applicable", "census", "lga_code_2021", "lga_name_2021", "state_code_2021", "state_name_2021", "areasqkm_2021", "cent_lat.1", "cent_long.1", "grouping", "geometry")

                      
```

This now allows the Hertiage, North-South and Outer East groups to be plotted separated and compared. 

```{r all_zones_car_as_driver, echo=FALSE, message=FALSE, warning=FALSE, fig.fullwidth=TRUE, fig.margin=FALSE, fig.cap="Comparing car, as driver mode shares across 2016 and 2021, and the three groupings"}

#Map destination zones
map <- Greater_Perth_JTW_by_DZ %>%
  filter(census != "Change: 2021 to 2016") %>%  #look at 2016 and 2021, but not the change.
  ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = `Car, as driver`),     # fill by Car, as driver
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf() +
  scale_fill_continuous(type = "viridis", labels=scales::percent) +
  facet_grid(row = vars(census), cols = vars(grouping), scales = "fixed")

map

```

Some changes are apparent. However, showing the differences between 2021 and 2016 directly gives: 


```{r difference_in_car_as_driver_mode_share, echo=FALSE, message=FALSE, warning=FALSE, fig.fullwidth=TRUE, fig.cap="Car, as driver mode shares, difference between 2021 and 2016"}

#Map destination zones
map <- Greater_Perth_JTW_by_DZ %>%
  filter(census == "Change: 2021 to 2016") %>%  #look at differnce between 2021 and 2016 only
  ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = `Car, as driver`),     # fill by Car, as driver
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf() +
  scale_fill_continuous(type = "viridis", labels=scales::percent) +
 facet_grid(cols = vars(grouping), scales = "fixed")


map

```

It appears that the largest changes have been in the outer east. Looking at the stats using the ggstatsplot package^[See https://indrajeetpatil.github.io/ggstatsplot/articles/web_only/ggwithinstats.html][@ggstatsplot]  


```{r difference_in_car_as_driver_mode_share_stats_tests, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE, fig.cap="Greater Perth, car driver mode share by destination zone, comparison between 2021 and 2016 censuses"}

Greater_Perth_JTW_by_DZ_no_geometry <- tibble(st_drop_geometry(Greater_Perth_JTW_by_DZ))
  
Greater_Perth_JTW_by_DZ_car_as_driver_wider <- 
  Greater_Perth_JTW_by_DZ_no_geometry  %>% 
    subset(select = c(dz_code, lga_name_2021, census, `Car, as driver`, grouping)) %>%
    filter(census != "Change: 2021 to 2016") %>% 
    filter(!is.na(`Car, as driver`)) %>%
  pivot_wider(
    names_from = census,
    values_from = `Car, as driver`
  )

#remove NA rows
Greater_Perth_JTW_by_DZ_car_as_driver_wider <- na.omit(Greater_Perth_JTW_by_DZ_car_as_driver_wider)

#return to long (tidy) format
Greater_Perth_JTW_by_DZ_car_as_driver <- pivot_longer(Greater_Perth_JTW_by_DZ_car_as_driver_wider, cols = c("2016", "2021"), names_to = "census", values_to = "Car, as driver")
                                                      
p <- grouped_ggwithinstats(
  data = Greater_Perth_JTW_by_DZ_car_as_driver, 
  x = census,
  y = `Car, as driver`,  
  grouping.var = grouping)

p

```

The box and violin plots show the differences in car, as driver mode shares between 2016 and 2021 for the various destination zones in the Heritage, North-south and Outer east groupings.  Changes in the car, as driver mode share by destination are significant for all three groupings, dropping from 69% to 67% for the Heritage grouping (p<0.01), from 68% to 67% for the North-south grouping (p<0.01), and from 69% to 68% for the Outer east grouping (p=0.03).

That concludes the outline of the methods used in this analysis. The following section shows results for each group and each mode. 

# 3.0 Results

## 3.1 Heritage group
### 3.1.1 Car, as driver

```{r Heritage_car, echo=FALSE, message=FALSE, warning=FALSE, fig.fullwidth=TRUE, fig.margin=FALSE, fig.cap="Heritage group, Car, as driver mode shares; 2016, 2021 and difference"}

#Map destination zones
map <- Greater_Perth_JTW_by_DZ %>%
  filter(grouping == "Heritage") %>%   #look at Heritage zone only
  ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = `Car, as driver`),     # fill by Car, as driver
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf() +
  scale_fill_continuous(type = "viridis", labels=scales::percent) +
  facet_grid(cols = vars(census), scales = "fixed")

map

```

In general, the car, as driver mode share has decreased across the Heritage area. The box and violin plot shows the difference in driver mode share by destination is significant, dropping from an average of 69% to 67% (p<0.01).

```{r Heritage_reshow_car_as_driver_mode_share_stats, fig.margin=TRUE, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Heritage group, car driver mode share by destination zone, comparison between 2021 and 2016 censuses"}
 
                                                      
p <- ggwithinstats(
  data = Greater_Perth_JTW_by_DZ_car_as_driver %>% filter(grouping == "Heritage"), 
  x = census,
  y = `Car, as driver`)

p


```

### 3.1.2 Car, as passenger


```{r Heritage_car_passenger, echo=FALSE, message=FALSE, warning=FALSE, fig.fullwidth=TRUE, fig.margin=FALSE, fig.cap="Heritage group, Car, as passenger mode shares; 2016, 2021 and difference"}

#Map destination zones
map <- Greater_Perth_JTW_by_DZ %>%
  filter(grouping == "Heritage") %>%   #look at Heritage zone only
  ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = `Car, as passenger`),     # fill by Car, as passenger
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf() +
  scale_fill_continuous(type = "viridis", labels=scales::percent) +
  facet_grid(cols = vars(census), scales = "fixed")

map

```
```{r Heritage_car_passenger_stats, fig.margin=FALSE, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Heritage group, car as passenger mode share by destination zone, comparison between 2021 and 2016 censuses"}
 

Greater_Perth_JTW_by_DZ_car_as_passenger_wider <- 
  Greater_Perth_JTW_by_DZ_no_geometry  %>% 
    subset(select = c(dz_code, lga_name_2021, census, `Car, as passenger`, grouping)) %>%
    filter(census != "Change: 2021 to 2016") %>% 
    filter(!is.na(`Car, as passenger`)) %>%
  pivot_wider(
    names_from = census,
    values_from = `Car, as passenger`
  )

#remove NA rows
Greater_Perth_JTW_by_DZ_car_as_passenger_wider <- na.omit(Greater_Perth_JTW_by_DZ_car_as_passenger_wider)

#return to long (tidy) format
Greater_Perth_JTW_by_DZ_car_as_passenger <- pivot_longer(Greater_Perth_JTW_by_DZ_car_as_passenger_wider, cols = c("2016", "2021"), names_to = "census", values_to = "Car, as passenger")
                                                      
p <- ggwithinstats(
  data = Greater_Perth_JTW_by_DZ_car_as_passenger %>% filter(grouping == "Heritage"), 
  x = census,
  y = `Car, as passenger`)

p

```

 The box and violin plot shows that the change in car, as passenger mode share by destination is not significant (p=0.68), averaging at 4% in both 2016 and 2021. There does, however, appear to be some variability in change by location, but no clear pattern. 



### 3.1.3 Train


```{r Heritage_train, echo=FALSE, message=FALSE, warning=FALSE, fig.fullwidth=TRUE, fig.margin=FALSE, fig.cap="Heritage group, train mode shares; 2016, 2021 and difference"}

#Map destination zones
map <- Greater_Perth_JTW_by_DZ %>%
  filter(grouping == "Heritage") %>%   #look at Heritage zone only
  ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = `Train`),     
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf() +
  scale_fill_continuous(type = "viridis", labels=scales::percent) +
  facet_grid(cols = vars(census), scales = "fixed")

map

```

```{r Heritage_Train_passenger_stats, fig.margin=FALSE, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Heritage group, train as passenger mode share by destination zone, comparison between 2021 and 2016 censuses"}
 

Greater_Perth_JTW_by_DZ_train_wider <- 
  Greater_Perth_JTW_by_DZ_no_geometry  %>% 
    subset(select = c(dz_code, lga_name_2021, census, Train, grouping)) %>%
    filter(census != "Change: 2021 to 2016") %>% 
    filter(!is.na(Train)) %>%
  pivot_wider(
    names_from = census,
    values_from = Train
  )

#remove NA rows
Greater_Perth_JTW_by_DZ_train_wider <- na.omit(Greater_Perth_JTW_by_DZ_train_wider)

#return to long (tidy) format
Greater_Perth_JTW_by_DZ_train <- pivot_longer(Greater_Perth_JTW_by_DZ_train_wider, cols = c("2016", "2021"), names_to = "census", values_to = "Train")
                                                      
p <- ggwithinstats(
  data = Greater_Perth_JTW_by_DZ_train %>% filter(grouping == "Heritage"), 
  x = census,
  y = `Train`)

p

```

 The box and violin plot shows the change in train mode share by destination is small, but significant (p<0.01). The average is `r Greater_Perth_JTW_by_DZ_train %>% filter(grouping == "Heritage") %>% filter(census == "2016") %>% subset(select="Train") %>% sapply(mean) %>% percent(accuracy=0.1)` in 2016, but `r Greater_Perth_JTW_by_DZ_train %>% filter(grouping == "Heritage") %>% filter(census == "2021") %>% subset(select="Train") %>% sapply(mean) %>% percent(accuracy=0.1)` in 2021. 
 
The maps might suggest that most of the change is in the central part of Perth, immediately in the 




```{r Heritage_train_zoom_map, echo=FALSE, message=FALSE, warning=FALSE, fig.fullwidth=TRUE, fig.margin=FALSE, fig.cap="Heritage group, train mode shares; 2016, 2021 and difference"}

#Map destination zones
map <- Greater_Perth_JTW_by_DZ %>%
  filter(grouping == "Heritage") %>%   #look at Heritage zone only
  ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = `Train`),     
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf() +
  scale_fill_continuous(type = "viridis", labels=scales::percent) +
  facet_grid(cols = vars(census), scales = "fixed")

map

```


## 3.2 North-south group

## 3.3 Outer east group


# 4.0 Discussion

# 5.0 Conclusions

#References



```{r bib, include=FALSE}
# create a bib file for the R packages used in this document
knitr::write_bib(c('base', 'rmarkdown'), file = 'skeleton.bib')
```
