---
title: "Perth COVID-19 study; journey to work census analysis"
runningheader: "Perth COVID-19 study; journey to work census analysis" # only for pdf output
subtitle: "Perth COVID-19 study; journey to work census analysis" # only for html output
author: "Dr James Reynolds, Monash University Public Transport Research Group (PTRG)"
date: "`r Sys.Date()`"
output:
  tufte::tufte_html: default
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
bibliography: Perth_JTW_census_analysis.bib
link-citations: yes
---

```{r setup, include=FALSE}
library(tufte)
library(tidyverse)
library(sp)
library(ggplot2)
library(sf)
library(ASGS.foyer)
library(raster)
library(ggmap)
library(units)
library(absmapsdata)
library(readabs)
library(readr)
library(janitor)
library(scales)
library(ggstatsplot)
library(ggmap)
library(knitr)
library(abs)
library(readr)

# invalidate cache when the tufte version changes
knitr::opts_chunk$set(cache.extra = packageVersion('tufte'))
options(htmltools.dir.version = FALSE)
```

# 1.0 Introduction
Monash University's Public Transport Research Group (PTRG) is looking at changes in travel behaviour in Perth surrounding the COVID-19 pandemic. Part of this work involves examining the Australian Bureau of Statistics (ABS) journey-to-work data for the 2016 and 2021 censuses. Areas of interest are: 

- an aggregate analysis for all of the Greater Perth area;

- a disaggregate analysis for three groupings of Perth Local Government Areas (LGAs) defined in previous PTRG work as: the North-south grouping^[City of Melville, City of South Perth, City of Stirling, City of Joondalup, City of Wanneroo, City of Cockburn, City of Kwinana, City of Rockingham, City of Murray and City of Mandurah.], the Heritage grouping ^[City of Bayswater, City of Belmont, City of Canning, City of Fremantle, City of Nedlands, City of Perth, City of Subiaco, City of Vincent, Shire of Peppermint Grove, Town of Bassendean, Town of Cambridge, Town of Claremont, Town of Cottesloe, Town of East Fremantle, Town of Mosman Park, Town of Victoria Park and City of Gosnells.] and the Outer-east grouping^[City of Kalamunda, City of Swan, Shire of Mundaring, City of Armadale, and Shire of Serpentine-Jarrahdale.].

-	Perth CBD^[Here the Central Perth area is adatoped, as depicted in the WADoT Perth Greater CBD Transport Plan https://www.transport.wa.gov.au/mediaFiles/projects/PROJECT_I_Perth_Greater_CBD_Transport_Plan_map.pdf]  / non-CBD-based Jobs, for all of Greater Perth and for the North-south, Heritage and Outer-east groupings
  
This working note details the process of collecting and reviewing the ABS data. It is structured as follows: the next section details the processing of the ABS data; Section 3 presents the results; followed by a brief discussion in Section 4; and conclusions in Section 5. 

# 2.0 Methods and data

# 2.1 Journey to work by LGA (usual residence) and LGA (place of work)
Data tables for the 2016 and 2021 census were obtained for the journey to work mode by LGA of Usual Residence (UR) and LGA of Place Of Work (POW).  


NEED TO UPDATE THE FILE DOWN LOADS FROM THE ABS to DOWNLOAD LGA (POW) for ALL AUSTRALIAN LGAs

```{r load_abs_2021_2016_destination_zones_correspondence_SA1_and_DZ, echo=FALSE, fig.margin=TRUE, fig.cap="Perth 2021 destination zonea", cache=TRUE}


####Next add the JTW data by DZ and LGA
## by Year and DZ and LGA data from ABS comes in a single file, with multiple CSV sections for each LGA. I found https://pypi.org/project/table_builder_io/ which deals with this issue over in python. 
##adapted from https://github.com/vlc/table_builder_io/ code in python
#from table_builder_io import TableBuilderReader
# Load python and pandas
#reader = TableBuilderReader.from_file("/Users/julianreynolds/Documents/work/Monash University/Greater_Perth_JTW_by_DZ_and_LGA_2021.csv")
#df = reader.read_table(as_index=True)
#df2 = reader.read(as_index=False)

##then from https://stackoverflow.com/a/55168518
#for i in df2: 
#   df2[i].to_csv('dataframe_id_'+str(i)+'.csv')
##All of this results in an output of everything in a separated CSV for each LGA. 
##Some stuffing around required as python does not play well with '0's and / etc in file names


#Load JTW by LGA (usual residence) and LGA (place of work)
list_csv_files <- list.files(path = "01 data/2016", full.names = TRUE)
LGA_UR_LGA_POW_JTW_2016 <- readr::read_csv(list_csv_files, id = "file_name")
list_csv_files <- list.files(path = "01 data/2021", full.names = TRUE)
LGA_UR_LGA_POW_JTW_2021 <- readr::read_csv(list_csv_files, id = "file_name")

#Extract LGA name from filename field
LGA_UR_LGA_POW_JTW_2016$lga_name_2016 <- sub(".*dataframe_id_","", LGA_UR_LGA_POW_JTW_2016$file_name)
LGA_UR_LGA_POW_JTW_2016$lga_name_2016 <- sub(".csv.*","", LGA_UR_LGA_POW_JTW_2016$lga_name_2016)
LGA_UR_LGA_POW_JTW_2021$lga_name_2021 <- sub(".*dataframe_id_","", LGA_UR_LGA_POW_JTW_2021$file_name)
LGA_UR_LGA_POW_JTW_2021$lga_name_2021 <- sub(".csv.*","", LGA_UR_LGA_POW_JTW_2021$lga_name_2021)

#clean names
LGA_UR_LGA_POW_JTW_2016 <- clean_names(LGA_UR_LGA_POW_JTW_2016)
LGA_UR_LGA_POW_JTW_2021 <- clean_names(LGA_UR_LGA_POW_JTW_2021)

#remove total rows
LGA_UR_LGA_POW_JTW_2016 <- LGA_UR_LGA_POW_JTW_2016 %>% filter(lga_pow  != "Total")
LGA_UR_LGA_POW_JTW_2021 <- LGA_UR_LGA_POW_JTW_2021 %>% filter(lga_pow  != "Total")

#remove unneeded column and set so that column names are consistent
##assume that 2021 LGAs are the same as 2016 LGAs
LGA_UR_LGA_POW_JTW_2016 <- tibble (lga_name_2021 = LGA_UR_LGA_POW_JTW_2016$lga_name_2016, LGA_UR_LGA_POW_JTW_2016[,3:19])
LGA_UR_LGA_POW_JTW_2021 <- tibble (lga_name_2021 = LGA_UR_LGA_POW_JTW_2021$lga_name_2021, LGA_UR_LGA_POW_JTW_2021[,3:19])

#Set 2021 column names to match 2016 column names
names(LGA_UR_LGA_POW_JTW_2021) <- c("lga_name_2021", "lga_pow", "train", "bus", "ferry", "tram", "taxi", "car_as_driver", "car_as_passenger", "truck", "motorbike_scooter", "bicycle", "other_mode",    "walked_only", "worked_at_home", "did_not_go_to_work", "not_stated", "not_applicable")    

```

Next, add the Heritage, North-south and Outer east groupings to the datasets. 
```{r add_groupings, echo=FALSE, fig.margin=TRUE, fig.cap="Perth 2021 destination zonea", cache=TRUE}
LGA_to_group <- tibble(lga_name_2021 = 
c("Melville", "South Perth", "Stirling", "Joondalup", "Wanneroo", "Cockburn", "Kwinana", "Rockingham", "Murray", "Mandurah",
  "Bayswater", "Belmont", "Canning","Fremantle", "Nedlands", "Perth", "Subiaco", "Vincent", "Peppermint Grove", "Bassendean", "Cambridge", "Claremont", "Cottesloe", "East Fremantle", "Mosman Park", "Victoria Park","Gosnells",
  "Kalamunda", "Swan", "Mundaring", "Armadale", "Serpentine-Jarrahdale", "Northam", "York"),
grouping = c("North-south", "North-south","North-south","North-south","North-south","North-south","North-south","North-south","North-south","North-south", "Heritage", "Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage", "Outer-east", "Outer-east","Outer-east","Outer-east","Outer-east", "Outer-east","Outer-east")
)

#join grouping to JTW data frames
LGA_UR_LGA_POW_JTW_2016 <- left_join(LGA_UR_LGA_POW_JTW_2016, LGA_to_group, by = "lga_name_2021")
LGA_UR_LGA_POW_JTW_2021 <- left_join(LGA_UR_LGA_POW_JTW_2021, LGA_to_group, by = "lga_name_2021")

#drop non_Greater_Perth places of usual residence
LGA_UR_LGA_POW_JTW_2016 <- LGA_UR_LGA_POW_JTW_2016[!is.na(LGA_UR_LGA_POW_JTW_2016$grouping),]
LGA_UR_LGA_POW_JTW_2021 <- LGA_UR_LGA_POW_JTW_2021[!is.na(LGA_UR_LGA_POW_JTW_2021$grouping),]                      

```

# 2.2 Population and employment data

I have also downloaded the age and employment data for all of WA's LGAs so that it is possible to calculate population and employed population for each of the Heritage, North-south and Outer east groupings. 

```{r load_employment_and_age_data_SA1_and_DZ, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.cap="Greater Perth: Heritage, North-south and Outer East groupings", cache=TRUE}

library(readr)
X2016_WA_age_by_LGA <- read_csv("01 data/2016_WA_Age_by_LGA.csv", skip = 8)
X2016_WA_employment_by_LGA <- read_csv("01 data/2016_WA_employment_by_LGA.csv", skip=8)
X2021_WA_age_by_LGA <- read_csv("01 data/2021_WA_Age_by_LGA.csv", skip=8)
X2021_WA_employment_by_LGA <- read_csv("01 data/2021_WA_Employment_by_LGA.csv", skip=8)

#drop empty first row and last 5 rows, and last 2 columns
X2016_WA_age_by_LGA <- X2016_WA_age_by_LGA[2:(nrow(X2016_WA_age_by_LGA)-5), 1:(ncol(X2016_WA_age_by_LGA)-2)]
X2016_WA_employment_by_LGA <- X2016_WA_employment_by_LGA[2:(nrow(X2016_WA_employment_by_LGA)-5), 1:(ncol(X2016_WA_employment_by_LGA)-2)]
X2021_WA_age_by_LGA <- X2021_WA_age_by_LGA[2:(nrow(X2021_WA_age_by_LGA)-5), 1:(ncol(X2021_WA_age_by_LGA)-2)]
X2021_WA_employment_by_LGA <- X2021_WA_employment_by_LGA[2:(nrow(X2021_WA_employment_by_LGA)-5), 1:(ncol(X2021_WA_employment_by_LGA)-2)]

#set characters to numeric for column two
#Whoops, downloaded the by individual years data instead of the 10 year groupings
X2016_WA_age_by_LGA$`0 years` <- as.numeric(unlist(X2016_WA_age_by_LGA[,2]))
X2016_WA_employment_by_LGA$`Fully engaged`<- as.numeric(unlist(X2016_WA_employment_by_LGA[,2]))
X2021_WA_age_by_LGA$`0-9 years` <- as.numeric(unlist(X2021_WA_age_by_LGA[,2]))
X2021_WA_employment_by_LGA$`Fully engaged`<- as.numeric(unlist(X2021_WA_employment_by_LGA[,2]))

#set names the same
names(X2016_WA_age_by_LGA) <- 
  c("lga_name_2021", 
    names(X2016_WA_age_by_LGA[,2:ncol(X2016_WA_age_by_LGA)]))
names(X2016_WA_employment_by_LGA) <- 
  c("lga_name_2021", 
    names(X2016_WA_employment_by_LGA[,2:ncol(X2016_WA_employment_by_LGA)]))
names(X2021_WA_age_by_LGA) <- 
  c("lga_name_2021", 
    names(X2021_WA_age_by_LGA[,2:ncol(X2021_WA_age_by_LGA)]))
names(X2021_WA_employment_by_LGA) <- 
  c("lga_name_2021", 
    names(X2021_WA_employment_by_LGA[,2:ncol(X2021_WA_employment_by_LGA)]))


#Remove (C) and similar from lga names
X2016_WA_age_by_LGA$lga_name_2021 <- sub(" (*).*","", X2016_WA_age_by_LGA$lga_name_2021)
X2016_WA_employment_by_LGA$lga_name_2021 <- sub(" (*).*","", X2016_WA_employment_by_LGA$lga_name_2021)
X2021_WA_age_by_LGA$lga_name_2021 <- sub(" (*).*","", X2021_WA_age_by_LGA$lga_name_2021)
X2021_WA_employment_by_LGA$lga_name_2021 <- sub(" (*).*","", X2021_WA_employment_by_LGA$lga_name_2021)

#join grouping to employment and age data frames
X2016_WA_age_by_LGA <- left_join(X2016_WA_age_by_LGA, LGA_to_group, by = "lga_name_2021")
X2016_WA_employment_by_LGA <- left_join(X2016_WA_employment_by_LGA, LGA_to_group, by = "lga_name_2021")
X2021_WA_age_by_LGA <- left_join(X2021_WA_age_by_LGA, LGA_to_group, by = "lga_name_2021")
X2021_WA_employment_by_LGA <- left_join(X2021_WA_employment_by_LGA, LGA_to_group, by = "lga_name_2021")


```



# 3.0 Results

## 3.1 Aggregate for Greater Perth
```{r Greater_Perth_JTW_aggregate, echo=FALSE, message=FALSE, warning=FALSE, fig.margin=FALSE, fig.fullwidth=FALSE, fig.cap="Greater Perth, journey to work mode share, 2021 and 2016 censuses"}

#calculate aggregates for everyone with a usual residence in perth
Aggregate_JTW_2016_2021 <- tibble(LGA_UR_LGA_POW_JTW_2016 %>% adorn_totals() %>% tail(n=1))
Aggregate_JTW_2016_2021 <- add_row(Aggregate_JTW_2016_2021, LGA_UR_LGA_POW_JTW_2021 %>% adorn_totals() %>% tail(n=1))

Aggregate_JTW_2016_2021$Year <- c("2016", "2021")

#combine modes to obtain PT, private vehicle (drive), private vehicle (passenger)  and non-motorised columns
Aggregate_JTW_2016_2021$private_vehicle_drive <- Aggregate_JTW_2016_2021$car_as_driver + Aggregate_JTW_2016_2021$truck + Aggregate_JTW_2016_2021$motorbike_scooter  

Aggregate_JTW_2016_2021$private_vehicle_passenger <- Aggregate_JTW_2016_2021$car_as_driver + Aggregate_JTW_2016_2021$taxi  

Aggregate_JTW_2016_2021$transit <- Aggregate_JTW_2016_2021$train + Aggregate_JTW_2016_2021$bus + Aggregate_JTW_2016_2021$ferry + Aggregate_JTW_2016_2021$tram

Aggregate_JTW_2016_2021$non_motorised <- Aggregate_JTW_2016_2021$bicycle + Aggregate_JTW_2016_2021$walked_only

#pivot_longer 
Aggregate_JTW_2016_2021_summary_longer <- pivot_longer(
  Aggregate_JTW_2016_2021[, c("Year", "private_vehicle_drive", "private_vehicle_passenger", "transit", "non_motorised", "other_mode", "worked_at_home")], 
  cols = c("private_vehicle_drive", "private_vehicle_passenger", "transit", "non_motorised", "other_mode", "worked_at_home"), 
  names_to = "Mode or activity",
  values_to = "People"
)

#turn mode into a factor to get a specific order
Aggregate_JTW_2016_2021_summary_longer$`Mode or activity` <- factor( Aggregate_JTW_2016_2021_summary_longer$`Mode or activity`, levels = c("work_at_home", "other_mode", "non_motorised", "transit", "private_vehicle_passenger", "private_vehicle_drive"))

p <- ggbarstats(
  Aggregate_JTW_2016_2021_summary_longer[,], 
  x = `Mode or activity`,
  y = Year,
  counts = People
)

p

kable(untabyl(Aggregate_JTW_2016_2021[,c("Year", "private_vehicle_drive", "private_vehicle_passenger", "transit", "non_motorised", "other_mode", "worked_at_home")]) %>% adorn_totals(where = "col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(), caption = "Journey to work mode/activity shares, persons with a usual residence in Greater Perth, 2016 and 2021 censuses"
)

```



# 4.0 Discussion

# 5.0 Conclusions

#References



```{r bib, include=FALSE}
# create a bib file for the R packages used in this document
knitr::write_bib(c('base', 'rmarkdown'), file = 'skeleton.bib')
```


