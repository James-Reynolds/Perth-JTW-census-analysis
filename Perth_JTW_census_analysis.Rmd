---
title: "Perth COVID-19 study; journey to work census analysis"
runningheader: "Perth COVID-19 study; journey to work census analysis" # only for pdf output
subtitle: "Perth COVID-19 study; journey to work census analysis" # only for html output
author: "Dr James Reynolds, Monash University Public Transport Research Group (PTRG)"
date: "`r Sys.Date()`"
output:
  tufte::tufte_html: default
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
bibliography: Perth_JTW_census_analysis.bib
link-citations: yes
---

```{r setup, include=FALSE}
library(tufte)
library(tidyverse)
library(sp)
library(ggplot2)
library(sf)
library(ASGS.foyer)
library(raster)
library(ggmap)
library(units)
library(absmapsdata)
library(readabs)
library(readr)
library(janitor)
library(scales)
library(ggstatsplot)
library(ggmap)

# invalidate cache when the tufte version changes
knitr::opts_chunk$set(cache.extra = packageVersion('tufte'))
options(htmltools.dir.version = FALSE)
```

# Introduction
The Monash University Public Transport Research Group is looking at changes in travel behaviour in Perth surrounding the COVID-19 pandemic. Part of this work involves examining the Australian Bureau of Statistics (ABS) data, with a particular emphasis on the 2016 and 2021 censuses. This working note details the process of collecting and reviewing the ABS data. It is structured as follows: the next section details the processing of the ABS data; Section 3 presents the results; followed by a brief discussion in Section 4; and conclusions in Section 5. 

# 2.0 Methods and data processing
Using the ABS data manipulation package absmapsdata [@absmapsdata]^[See https://github.com/wfmackey/absmapsdata], to download the Destination Zone files. 

```{r load_abs_data, echo=FALSE, fig.fullwidth=TRUE, fig.cap="Perth 2016 destination zonea", cache=TRUE}

#Load DZ2016 data
DZ2016_map_data <- dz2016

#Load SA1_2016 data
sa1_2016_map_data <- sa12016

#Get the Greater Capital City names by sa2 
sa2_gcc_code <- tibble(sa2_code_2016 = sa1_2016_map_data$sa2_code_2016,
                       sa2_name_2016 = sa1_2016_map_data$sa2_name_2016,
                       gcc_name_2016 = sa1_2016_map_data$gcc_name_2016)
#and only keep unique records
sa2_gcc_code <- distinct(sa2_gcc_code)



#join gcc_name_2016 into DZ2016 dataset
DZ2016_map_data_joined_gcc <- left_join(DZ2016_map_data, sa2_gcc_code, by = "sa2_code_2016")


#convert square km values back to numeric class
DZ2016_map_data_joined_gcc$areasqkm_2016 <- as.numeric(DZ2016_map_data_joined_gcc$areasqkm_2016) 

#Map destination zones
map <- DZ2016_map_data_joined_gcc %>%
  filter(gcc_name_2016 == "Greater Perth") %>%   # let's just look at Perth
  ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = areasqkm_2016),     # fill by area size
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf()

map

```

Next load the 2021 destination zones

```{r load_abs_2021_destination_zones_data, echo=FALSE, fig.fullwidth=TRUE, fig.cap="Perth 2021 destination zonea", cache=TRUE}

#Load DZ2021 data
DZ2021_map_data <- dz2021

#Load SA1_2021 data
sa1_2021_map_data <- sa12021

#Get the Greater Capital City names by sa2 
sa2_gcc_code <- tibble(sa2_code_2021 = sa1_2021_map_data$sa2_code_2021,
                       sa2_name_2021 = sa1_2021_map_data$sa2_name_2021,
                       gcc_name_2021 = sa1_2021_map_data$gcc_name_2021)
#and only keep unique records
sa2_gcc_code <- distinct(sa2_gcc_code)


#join gcc_name_2021 into DZ2021 dataset
DZ2021_map_data_joined_gcc <- left_join(DZ2021_map_data, sa2_gcc_code, by = "sa2_code_2021")

#convert square km values back to numeric class
DZ2021_map_data_joined_gcc$areasqkm_2021 <- as.numeric(DZ2021_map_data_joined_gcc$areasqkm_2021) 



#Map destination zones
map <- DZ2021_map_data_joined_gcc %>%
  filter(gcc_name_2021 == "Greater Perth") %>%   # let's just look at Perth
  ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = areasqkm_2021),     # fill by area size
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf()

map

```


Next, load the ABS journey to work data, turn it into percentages and join it to the DZ data. 

```{r load_abs_jtw_data, echo=FALSE, fig.margin=TRUE, fig.cap="Greater Perth, car driver mode share by destination zone, 2016", cache=TRUE}

Greater_Perth_JTW_by_destination_2016 <- read_csv("01 data/Greater_Perth_JTW_by_destination_2016.csv", 
    skip = 8)
Greater_Perth_JTW_by_destination_2021 <- read_csv("01 data/Greater_Perth_JTW_by_destination_2021.csv", 
    skip = 8)
Greater_Perth_JTW_by_origin_2016 <- read_csv("01 data/Greater_Perth_JTW_by_origin_2016.csv", 
    skip = 8)
Greater_Perth_JTW_by_origin_2021 <- read_csv("01 data/Greater_Perth_JTW_by_origin_2021.csv", 
    skip = 8)



#remove first empty row and last 5 rows with copywrite info
Greater_Perth_JTW_by_destination_2016 <- Greater_Perth_JTW_by_destination_2016[2:(nrow(Greater_Perth_JTW_by_destination_2016)-5),]
Greater_Perth_JTW_by_destination_2021<- Greater_Perth_JTW_by_destination_2021[2:(nrow(Greater_Perth_JTW_by_destination_2021)-5),]
Greater_Perth_JTW_by_origin_2016 <- Greater_Perth_JTW_by_origin_2016[2:(nrow(Greater_Perth_JTW_by_origin_2016)-5),]
Greater_Perth_JTW_by_origin_2021 <- Greater_Perth_JTW_by_origin_2021[2:(nrow(Greater_Perth_JTW_by_origin_2021)-5),]

#Train column as numeric
Greater_Perth_JTW_by_destination_2016$Train <- as.numeric(Greater_Perth_JTW_by_destination_2016$Train)
Greater_Perth_JTW_by_destination_2021$Train <- as.numeric(Greater_Perth_JTW_by_destination_2021$Train)


#update first column name to be dz_code_2016
names(Greater_Perth_JTW_by_destination_2016) <- 
  c("dz_code_2016", 
    names(Greater_Perth_JTW_by_destination_2016[,2:ncol(Greater_Perth_JTW_by_destination_2016)]))
#Do same update first column name to be dz_code_2021
names(Greater_Perth_JTW_by_destination_2021) <- 
  c("dz_code_2021", 
    names(Greater_Perth_JTW_by_destination_2021[,2:ncol(Greater_Perth_JTW_by_destination_2021)]))



#drop total column and convert to percentages
Greater_Perth_JTW_by_destination_2016 <- tibble(Greater_Perth_JTW_by_destination_2016[,1:17] %>% adorn_percentages()) 
Greater_Perth_JTW_by_destination_2021 <- tibble(Greater_Perth_JTW_by_destination_2021[,1:17] %>% adorn_percentages())

# and join
Greater_Perth_JTW_by_DZ2016_2016 <- right_join(DZ2016_map_data_joined_gcc, Greater_Perth_JTW_by_destination_2016, by = "dz_code_2016")
# and join
Greater_Perth_JTW_by_DZ2021_2021 <- right_join(DZ2021_map_data_joined_gcc, Greater_Perth_JTW_by_destination_2021, by = "dz_code_2021")


#Map destination zones
map <- Greater_Perth_JTW_by_DZ2016_2016 %>%
  filter(gcc_name_2016 == "Greater Perth") %>%   # let's just look at Perth
  ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = `Car, as driver`),     # fill by car driver mode share
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf() +
  scale_fill_continuous(labels=scales::percent)


map


```
The margin figure shows the 'car, as driver' journey to work mode shift for 2016.  The next steps will therefore be to show the results for 2016, 2021 and the difference between the two as a single figure for each mode.

```{r shift_into_one_data_frame_and_calculate_differences, echo=FALSE, fig.margin=TRUE, fig.cap="Greater Perth, car driver mode share by destination zone, 2016", cache=TRUE}

#move 2016 data into combined dataframe
Greater_Perth_JTW_by_DZ <- Greater_Perth_JTW_by_DZ2016_2016
#strip 2016 from column names and match to 2021 column names
names(Greater_Perth_JTW_by_DZ) <- c("dz_code", "sa2_code", "sa2_shortcode", "sa2_name.x", "state_code", "state_name",
"areasqkm", "cent_lat", "cent_long", "sa2_name.y",  "gcc_name", "Train", "Bus", "Ferry", "Tram/light rail", "Taxi/ride-share service", "Car, as driver", "Car, as passenger", "Truck", "Motorbike/scooter", "Bicycle", "Walked only", "Other mode","Worked at home", "Did not got to work", "Not stated", "Not applicable", "geometry")

#add census year identifier
Greater_Perth_JTW_by_DZ$census <- "2016"

#add 2021 as rows to the combined dataframe
Greater_Perth_JTW_by_DZ <- Greater_Perth_JTW_by_DZ %>% add_row(
  dz_code = Greater_Perth_JTW_by_DZ2021_2021$dz_code_2021, 
  sa2_code = Greater_Perth_JTW_by_DZ2021_2021$sa2_code_2021, 
  sa2_shortcode = NA, 
  sa2_name.x = Greater_Perth_JTW_by_DZ2021_2021$sa2_name_2021.x, 
  state_code = Greater_Perth_JTW_by_DZ2021_2021$state_code_2021, 
  state_name = Greater_Perth_JTW_by_DZ2021_2021$state_name_2021, 
  areasqkm = Greater_Perth_JTW_by_DZ2021_2021$areasqkm_2021,
  cent_lat = Greater_Perth_JTW_by_DZ2021_2021$cent_lat,
  cent_long = Greater_Perth_JTW_by_DZ2021_2021$cent_long,
  sa2_name.y = Greater_Perth_JTW_by_DZ2021_2021$sa2_name_2021.y,
  gcc_name = Greater_Perth_JTW_by_DZ2021_2021$gcc_name_2021,
  Train = Greater_Perth_JTW_by_DZ2021_2021$Train,
  Bus = Greater_Perth_JTW_by_DZ2021_2021$Bus,
  Ferry = Greater_Perth_JTW_by_DZ2021_2021$Ferry,
  `Tram/light rail` = Greater_Perth_JTW_by_DZ2021_2021$`Tram/light rail`,
  `Taxi/ride-share service` = Greater_Perth_JTW_by_DZ2021_2021$`Taxi/ride-share service`,
  `Car, as driver` = Greater_Perth_JTW_by_DZ2021_2021$`Car, as driver`,
  `Car, as passenger` = Greater_Perth_JTW_by_DZ2021_2021$`Car, as passenger`,
  Truck = Greater_Perth_JTW_by_DZ2021_2021$Truck,
  `Motorbike/scooter` = Greater_Perth_JTW_by_DZ2021_2021$`Motorbike/scooter`,
  Bicycle = Greater_Perth_JTW_by_DZ2021_2021$Bicycle,
  `Walked only` = Greater_Perth_JTW_by_DZ2021_2021$`Walked only`,
  `Other mode` = Greater_Perth_JTW_by_DZ2021_2021$`Other Mode`,
  `Worked at home` = Greater_Perth_JTW_by_DZ2021_2021$`Worked at home`,
  `Did not got to work` = Greater_Perth_JTW_by_DZ2021_2021$`Did not go to work`,
  `Not stated` = Greater_Perth_JTW_by_DZ2021_2021$`Not stated`,
  `Not applicable` = Greater_Perth_JTW_by_DZ2021_2021$`Not applicable`,
  geometry = Greater_Perth_JTW_by_DZ2021_2021$geometry,
  census = "2021")
                
##create a dataframe that has the difference between the 2021 and 2016 mode shares, by 2021 DZ code
#first insert 2016 data
Greater_Perth_JTW_by_destination_2021_minus_2016 <-Greater_Perth_JTW_by_destination_2016
#change column names to distinguish between 2021 and 2016, and to match 2021 Dz codes to 2016 Dz codes
names(Greater_Perth_JTW_by_destination_2021_minus_2016) <- c(
  "dz_code_2021", 
  "Train_2016", 
  "Bus_2016", 
  "Ferry_2016", 
  "Tram/light rail_2016", 
  "Taxi/ride-share service_2016", 
  "Car, as driver_2016", 
  "Car, as passenger_2016", 
  "Truck_2016", 
  "Motorbike/scooter_2016", 
  "Bicycle_2016", 
  "Walked only_2016", 
  "Other mode_2016",
  "Worked at home_2016", 
  "Did not got to work_2016", 
  "Not stated_2016", 
  "Not applicable_2016")
#join based on Dz code
Greater_Perth_JTW_by_destination_2021_minus_2016 <- left_join(Greater_Perth_JTW_by_destination_2021_minus_2016, Greater_Perth_JTW_by_destination_2021)
#subtract 2016 from 2021
Greater_Perth_JTW_by_destination_2021_minus_2016$Train <- Greater_Perth_JTW_by_destination_2021_minus_2016$Train - Greater_Perth_JTW_by_destination_2021_minus_2016$Train_2016
Greater_Perth_JTW_by_destination_2021_minus_2016$Bus <- Greater_Perth_JTW_by_destination_2021_minus_2016$Bus - Greater_Perth_JTW_by_destination_2021_minus_2016$Bus_2016
Greater_Perth_JTW_by_destination_2021_minus_2016$Ferry <- Greater_Perth_JTW_by_destination_2021_minus_2016$Ferry - Greater_Perth_JTW_by_destination_2021_minus_2016$Ferry_2016
Greater_Perth_JTW_by_destination_2021_minus_2016$`Tram/light rail` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Tram/light rail` - Greater_Perth_JTW_by_destination_2021_minus_2016$`Tram/light rail_2016`
Greater_Perth_JTW_by_destination_2021_minus_2016$`Taxi/ride-share service` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Taxi/ride-share service` -  Greater_Perth_JTW_by_destination_2021_minus_2016$`Taxi/ride-share service_2016`
Greater_Perth_JTW_by_destination_2021_minus_2016$`Car, as driver` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Car, as driver` - Greater_Perth_JTW_by_destination_2021_minus_2016$`Car, as driver_2016`
Greater_Perth_JTW_by_destination_2021_minus_2016$`Car, as passenger` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Car, as passenger`- Greater_Perth_JTW_by_destination_2021_minus_2016$`Car, as passenger_2016`
Greater_Perth_JTW_by_destination_2021_minus_2016$Truck <- Greater_Perth_JTW_by_destination_2021_minus_2016$Truck- Greater_Perth_JTW_by_destination_2021_minus_2016$Truck_2016
Greater_Perth_JTW_by_destination_2021_minus_2016$`Motorbike/scooter` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Motorbike/scooter`- Greater_Perth_JTW_by_destination_2021_minus_2016$`Motorbike/scooter_2016`
Greater_Perth_JTW_by_destination_2021_minus_2016$Bicycle <- Greater_Perth_JTW_by_destination_2021_minus_2016$Bicycle- Greater_Perth_JTW_by_destination_2021_minus_2016$Bicycle_2016
Greater_Perth_JTW_by_destination_2021_minus_2016$`Other Mode` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Other Mode`- Greater_Perth_JTW_by_destination_2021_minus_2016$`Other mode_2016`
Greater_Perth_JTW_by_destination_2021_minus_2016$`Walked only` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Walked only`- Greater_Perth_JTW_by_destination_2021_minus_2016$`Walked only_2016`
Greater_Perth_JTW_by_destination_2021_minus_2016$`Worked at home` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Worked at home`- Greater_Perth_JTW_by_destination_2021_minus_2016$`Worked at home_2016`
Greater_Perth_JTW_by_destination_2021_minus_2016$`Did not go to work` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Did not go to work`- Greater_Perth_JTW_by_destination_2021_minus_2016$`Did not got to work_2016`
Greater_Perth_JTW_by_destination_2021_minus_2016$`Not stated` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Not stated`- Greater_Perth_JTW_by_destination_2021_minus_2016$`Not stated_2016`
Greater_Perth_JTW_by_destination_2021_minus_2016$`Not applicable` <- Greater_Perth_JTW_by_destination_2021_minus_2016$`Not applicable`- Greater_Perth_JTW_by_destination_2021_minus_2016$`Not applicable_2016`

#join difference between 2021 and 2016 to DZ geometry
Greater_Perth_JTW_by_destination_2021_minus_2016 <- right_join(DZ2021_map_data_joined_gcc, Greater_Perth_JTW_by_destination_2021_minus_2016, by = "dz_code_2021")


#add difference between 2021 and 2016 as rows to the combined dataframe
Greater_Perth_JTW_by_DZ <- Greater_Perth_JTW_by_DZ %>% add_row(
  dz_code = Greater_Perth_JTW_by_destination_2021_minus_2016$dz_code_2021, 
  sa2_code = Greater_Perth_JTW_by_destination_2021_minus_2016$sa2_code_2021, 
  sa2_shortcode = NA, 
  sa2_name.x = Greater_Perth_JTW_by_destination_2021_minus_2016$sa2_name_2021.x, 
  state_code = Greater_Perth_JTW_by_destination_2021_minus_2016$state_code_2021, 
  state_name = Greater_Perth_JTW_by_destination_2021_minus_2016$state_name_2021, 
  areasqkm = Greater_Perth_JTW_by_destination_2021_minus_2016$areasqkm_2021,
  cent_lat = Greater_Perth_JTW_by_destination_2021_minus_2016$cent_lat,
  cent_long = Greater_Perth_JTW_by_destination_2021_minus_2016$cent_long,
  sa2_name.y = Greater_Perth_JTW_by_destination_2021_minus_2016$sa2_name_2021.y,
  gcc_name = Greater_Perth_JTW_by_destination_2021_minus_2016$gcc_name_2021,
  Train = Greater_Perth_JTW_by_destination_2021_minus_2016$Train,
  Bus = Greater_Perth_JTW_by_destination_2021_minus_2016$Bus,
  Ferry = Greater_Perth_JTW_by_destination_2021_minus_2016$Ferry,
  `Tram/light rail` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Tram/light rail`,
  `Taxi/ride-share service` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Taxi/ride-share service`,
  `Car, as driver` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Car, as driver`,
  `Car, as passenger` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Car, as passenger`,
  Truck = Greater_Perth_JTW_by_destination_2021_minus_2016$Truck,
  `Motorbike/scooter` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Motorbike/scooter`,
  Bicycle = Greater_Perth_JTW_by_destination_2021_minus_2016$Bicycle,
  `Walked only` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Walked only`,
  `Other mode` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Other Mode`,
  `Worked at home` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Worked at home`,
  `Did not got to work` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Did not go to work`,
  `Not stated` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Not stated`,
  `Not applicable` = Greater_Perth_JTW_by_destination_2021_minus_2016$`Not applicable`,
  geometry = Greater_Perth_JTW_by_destination_2021_minus_2016$geometry,
  census = "Change: 2021 to 2016")
 


```

It would help if the different analysis areas can be identified for each destination zone. The analysis areas were defined in Graham's sample size jottings worksheet as North-South Group ^[City of Melville, City of South Perth, City of Stirling, City of Joondalup, City of Wanneroo, City of Cockburn, City of Kwinana, City of Rockingham, City of Murray and City of Mandurah.], the Heritage Group ^[City of Bayswater, City of Belmont, City of Canning, City of Fremantle, City of Nedlands, City of Perth, City of Subiaco, City of Vincent, Shire of Peppermint Grove, Town of Bassendean, Town of Cambridge, Town of Claremont, Town of Cottesloe, Town of East Fremantle, Town of Mosman Park, Town of Victoria Park and City of Gosnells.] and the Outer East^[City of Kalamunda, City of Swan, Shire of Mundaring, City of Armadale, and Shire of Serpentine-Jarrahdale.].



```{r add_groupings, echo=FALSE, fig.margin=TRUE, fig.cap="Greater Perth, car driver mode share by destination zone, 2016", cache=TRUE}

#get ABS LGA boundaries
lga_areas <- lga2021 %>% filter(state_name_2021 == "Western Australia")

#find intersections of Destination zones and LGA boundaries
Greater_Perth_JTW_by_DZ <- st_intersection(Greater_Perth_JTW_by_DZ, lga_areas)

LGA_to_group <- tibble(lga_name_2021 = 
c("Melville", "South Perth", "Stirling", "Joondalup", "Wanneroo", "Cockburn", "Kwinana", "Rockingham", "Murray", "Mandurah",
  "Bayswater", "Belmont", "Canning","Fremantle", "Nedlands", "Perth", "Subiaco", "Vincent", "Peppermint Grove", "Bassendean", "Cambridge", "Claremont", "Cottesloe", "East Fremantle", "Mosman Park", "Victoria Park","Gosnells",
  "Kalamunda", "Swan", "Mundaring", "Armadale", "Serpentine-Jarrahdale"),
grouping = c("North-south", "North-south","North-south","North-south","North-south","North-south","North-south","North-south","North-south","North-south", "Heritage", "Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage","Heritage", "Outer east", "Outer east","Outer east","Outer east","Outer east")
)

#join grouping to DZ
Greater_Perth_JTW_by_DZ <- left_join(Greater_Perth_JTW_by_DZ, LGA_to_group, by = "lga_name_2021")
   

#Map Groupings
map <- Greater_Perth_JTW_by_DZ %>%
    ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = grouping),     # fill by grouping
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf() 

map


                      
```




# 3.0 Results

## 3.1 Private vehicles 

### 3.1.1 Car as driver

```{r Car_as_driver_mode_share_change, fig.margin=FALSE, fig.cap="Greater Perth, car driver mode share by destination zone}

#Map car drive mode share
map <- Greater_Perth_JTW_by_DZ %>%
  filter(census != "Change: 2021 to 2016") %>% # let's just look at 2021 and 2016  
  ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = `Car..as.driver`),     # fill by car driver mode share
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf() +
  scale_fill_continuous(type = "viridis", labels=scales::percent) +
  facet_grid(rows = vars(census), cols = vars(grouping), scales = "fixed")
map

```
There appear to have been some changes in car, as driver mode split between 2016 and 2021. However, the comparison is a bit difficult to see. Instead comparing the change in mode share percentage directly gives: 


```{r Car_as_driver_mode_share_change_compare, fig.margin=FALSE, fig.cap="Greater Perth, car driver mode share by destination zone, difference between 2021 and 2016, heritage zone}

#Map destination zones
map <- Greater_Perth_JTW_by_DZ %>%
  filter(census == "Change: 2021 to 2016") %>%   # let's just look at change between 2021 and 2016
  filter(grouping == "Heritage") %>%   # let's just look at Heritage zone
  ggplot() +
  geom_sf(aes(geometry = geometry,  # use the geometry variable
              fill = `Car..as.driver`),     # fill by car driver mode share
          lwd = 0,                  # remove borders
          show.legend = TRUE) +    # keep legend
 # geom_point(aes(cent_long,
  #               cent_lat),        # use the centroid long (x) and lats (y)
   #          colour = "white") +    # make the points white
  theme_void() +                    # clears other plot elements
  coord_sf() +
  scale_fill_continuous(type = "viridis", labels=scales::percent) +
  facet_grid(cols = vars(grouping), scales = "fixed")

map

```

Here the ggstatsplot package^[See https://indrajeetpatil.github.io/ggstatsplot/articles/web_only/ggwithinstats.html][@ggstatsplot] is used. 


```{r Car_as_driver_mode_share_change_ggstatsplot, fig.margin=FALSE, fig.cap="Greater Perth, car driver mode share by destination zone, comparison between 2021 and 2016 censuses"}

Greater_Perth_JTW_by_DZ_no_geometry <- tibble(st_drop_geometry(Greater_Perth_JTW_by_DZ))
  
Greater_Perth_JTW_by_DZ_car_as_driver_wider <- 
  Greater_Perth_JTW_by_DZ_no_geometry  %>% 
    subset(select = c(dz_code, lga_name_2021, census, `Car..as.driver`, grouping)) %>%
    filter(census != "Change: 2021 to 2016") %>% 
    filter(!is.na(`Car..as.driver`)) %>%
  pivot_wider(
    names_from = census,
    values_from = `Car..as.driver`
  )

#remove NA rows
Greater_Perth_JTW_by_DZ_car_as_driver_wider <- na.omit(Greater_Perth_JTW_by_DZ_car_as_driver_wider)

#return to long (tidy) format
Greater_Perth_JTW_by_DZ_car_as_driver <- pivot_longer(Greater_Perth_JTW_by_DZ_car_as_driver_wider, cols = c("2016", "2021"), names_to = "census", values_to = "Car, as driver")
                                                      

p <- grouped_ggwithinstats(
  Greater_Perth_JTW_by_DZ_car_as_driver,
  x = census,
  y = "Car, as driver",
  type = "p",
  grouping.var = grouping
)

p
extract_stats(p)
```


# 4.0 Discussion

# 5.0 Conclusions

#References



```{r bib, include=FALSE}
# create a bib file for the R packages used in this document
knitr::write_bib(c('base', 'rmarkdown'), file = 'skeleton.bib')
```
